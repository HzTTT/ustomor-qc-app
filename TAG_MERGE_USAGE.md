# 标签合并功能使用指南

## 快速开始

标签合并功能已成功添加到系统中！现在您可以轻松地将重复或需要整理的标签合并为一个。

## 访问入口

1. 登录系统（需要管理员或主管权限）
2. 进入 **设置 → 标签管理** 页面：`http://localhost:8000/settings/tags`
3. 选择"全部浏览"或"分栏管理"模式

## 使用步骤

### 步骤 1：找到需要合并的标签

在标签列表中找到您想要合并掉的标签（源标签）。

### 步骤 2：打开操作面板

点击该标签右侧的"编辑/停用"按钮，展开操作面板。

### 步骤 3：选择目标标签

在操作面板底部，您会看到"合并到另一个标签"区域：

```
合并到另一个标签：
[下拉选择器：选择目标标签...]
[合并到目标标签] 按钮
```

从下拉列表中选择您想要保留的标签（目标标签）。下拉列表按分类分组显示所有可用标签。

### 步骤 4：执行合并

1. 点击"合并到目标标签"按钮
2. 系统会弹出确认对话框：
   ```
   确定要合并吗？
   
   将把「源标签名」的所有对话标记转移到目标标签，然后删除「源标签名」。
   此操作不可恢复。
   ```
3. 仔细核对信息后，点击"确定"

### 步骤 5：查看结果

合并完成后，页面会显示操作结果，例如：
```
已合并：未及时回复 → 回复不及时；
迁移命中23条（去重5条），迁移手动标记8条（去重2条）
```

## 使用示例

### 示例 1：合并重复标签

**场景**：发现系统中有两个意思相同的标签
- 标签 A："未及时回复"
- 标签 B："回复不及时"

**操作**：
1. 决定保留"回复不及时"（目标标签）
2. 找到"未及时回复"标签
3. 在操作面板中选择"回复不及时"作为目标标签
4. 点击合并
5. 完成后，所有原本标记为"未及时回复"的对话都会显示为"回复不及时"

### 示例 2：标签规范化

**场景**：要将细分标签合并到统一标签
- 标签 A："色差"
- 标签 B："做工问题"  
- 目标标签："色差/做工问题"

**操作**：
1. 先将"色差"合并到"色差/做工问题"
2. 再将"做工问题"合并到"色差/做工问题"
3. 最终所有相关对话都统一使用"色差/做工问题"标签

## 功能特性

### ✅ 完整迁移

合并操作会迁移：
- **AI 自动命中记录**：过去 AI 分析自动打上的标签
- **手动标记记录**：管理员/主管手动添加的标签

### ✅ 智能去重

如果同一个对话同时被源标签和目标标签标记，系统会自动去重：
- 保留目标标签的记录
- 删除源标签的重复记录
- 在结果中显示去重数量

### ✅ 数据完整性

- 历史对话的标签统计保持准确
- 报表中的标签数据自动更新
- 不影响对话的其他分析结果

## 注意事项

### ⚠️ 操作不可逆

标签合并后**无法自动撤销**，请务必：
1. 仔细确认源标签和目标标签
2. 理解两个标签的含义和区别
3. 必要时先导出标签配置作为备份

### ⚠️ 权限要求

只有以下角色可以执行标签合并：
- 管理员（admin）
- 主管（supervisor）

普通客服（agent）无权限执行此操作。

### ⚠️ 影响范围

合并操作会影响：
- 所有使用该标签的历史对话
- 标签统计报表
- 标签筛选功能

### ⚠️ 操作建议

1. **先测试后推广**
   - 先在测试环境尝试
   - 或先合并一两个不常用的标签
   - 确认流程无误后再批量操作

2. **记录变更**
   - 记录合并的标签及原因
   - 便于后续追溯和团队沟通

3. **分批处理**
   - 一次合并一个标签
   - 每次合并后检查结果
   - 避免一次性大量操作导致混乱

## 常见问题

### Q1: 合并后可以撤销吗？

A: 不能自动撤销。如需恢复，可以：
- 重新创建被删除的标签
- 使用批量导入功能从备份恢复
- 联系技术人员通过数据库操作恢复（需要专业知识）

### Q2: 合并后原来的对话会丢失标签吗？

A: 不会。原来被源标签标记的对话，合并后会显示目标标签。数据完整性得到保证。

### Q3: 可以跨分类合并标签吗？

A: 可以。目标标签可以来自任何分类。下拉选择器中会按分类分组显示所有标签。

### Q4: 合并操作需要多长时间？

A: 通常在几秒内完成。具体时间取决于源标签的使用频率（标记的对话数量）。

### Q5: 合并时系统会停止服务吗？

A: 不会。合并操作在后台执行，不影响其他用户使用系统。

## 技术支持

如遇到问题，请：
1. 查看 `docs/TAG_MERGE_FEATURE.md` 技术文档
2. 检查应用日志：`docker compose logs app`
3. 联系系统管理员或技术支持团队

## 相关功能

- **停用标签**：保留标签但不再使用
- **彻底删除标签**：删除标签及所有相关记录
- **批量导入标签**：从 Excel 文件导入标签配置
- **标签报表**：查看标签使用统计

## 更新日志

- **2026-01-30**：标签合并功能正式上线
  - 支持 AI 命中记录迁移
  - 支持手动标记迁移
  - 自动去重处理
  - 详细的操作结果反馈
