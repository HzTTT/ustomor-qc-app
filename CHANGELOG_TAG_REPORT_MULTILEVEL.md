# 标签报表多层折叠功能更新日志

## 更新时间
2026-02-02

## 功能概述
将标签报表页面重构为多层嵌套折叠结构，支持汇总 → 平台 → 客服三级展开，并修改默认时间维度为"周"。

## 主要变更

### 1. 默认时间维度调整
- **文件**: `app/main.py` (第4559行)
- **变更**: 将默认时间维度从 `yesterday`（昨天）改为 `last_week`（上周）
- **影响**: 用户访问标签报表时，默认显示上周的数据

### 2. 数据结构增强
- **文件**: `app/main.py` (第4920-5041行)
- **变更**: 
  - 为 `_add_group` 函数添加 `level` 和 `parent_id` 参数
  - 每行数据增加层级信息：
    - `level: 0` = 汇总层
    - `level: 1` = 平台层
    - `level: 2` = 客服层
  - 每行数据增加 `parent_id` 字段，建立父子关系

### 3. 前端模板重构
- **文件**: `app/templates/tags_report.html` (第80-129行)
- **变更**:
  - 表格行增加 `data-level`、`data-parent`、`data-group` 属性
  - 根据 level 添加缩进样式（每层缩进 20px）
  - 默认隐藏所有 `level > 0` 的行（折叠状态）
  - Header 行图标默认为 `▸`（折叠状态）

### 4. JavaScript 交互逻辑
- **文件**: `app/templates/tags_report.html` (第169-198行)
- **变更**:
  - 重写 `toggleGroup` 函数，支持多层嵌套折叠
  - 展开时：只显示直接子元素
  - 折叠时：递归隐藏所有后代元素
  - 新增 `hideAllDescendants` 辅助函数

## 数据层级结构

```
▸ 汇总 (level=0, group_id="summary")
  ├─ 一级分类A | 二级标签1 | 10 | +2 | -1
  ├─ 一级分类A | 二级标签2 | 5  | +1 | 0
  └─ ...
  
  ▸ 平台：taobao (level=1, group_id="plat-taobao", parent="summary")
    ├─ 一级分类A | 二级标签1 | 6 | +1 | -1
    └─ ...
    
    ▸ 站内客服：张三 (level=2, group_id="plat-taobao-u1", parent="plat-taobao")
      ├─ 一级分类A | 二级标签1 | 3 | +1 | 0
      └─ ...
```

## 用户体验改进

### 页面加载
- 默认只显示汇总 header 行（折叠状态）
- 所有标签明细行默认隐藏
- 减少初始渲染的数据量，提升页面加载速度

### 交互流程
1. **点击汇总 header** → 展开显示：
   - 汇总的标签明细行
   - 所有平台的 header 行（折叠状态）
2. **点击平台 header** → 展开显示：
   - 该平台的标签明细行
   - 该平台下所有客服的 header 行（折叠状态）
3. **点击客服 header** → 展开显示：
   - 该客服的标签明细行
4. **再次点击任意 header** → 折叠隐藏：
   - 该层级的标签明细行
   - 所有子级的 header 和明细行

### 视觉反馈
- 折叠状态：`▸` 图标
- 展开状态：`▾` 图标
- 层级缩进：每层缩进 20px，清晰展示层级关系

## 向后兼容性
- ✅ 保留所有原有列（维度、一级分类、二级标签、对话数、环比、同比）
- ✅ 保留所有筛选条件（时间维度、日期范围、平台、站内客服、同比）
- ✅ 保留所有交互功能（查看标签标准、查看对话列表）
- ✅ 数据统计口径不变（每个对话取最新一条 AI 质检的命中标签）

## 技术细节

### 前端性能优化
- 使用 CSS `hidden` 类控制显示/隐藏，避免 DOM 操作
- 递归折叠使用高效的 `querySelectorAll` 查询
- 图标切换使用简单的文本替换

### 数据完整性
- 每个层级都有完整的标签明细数据
- 汇总层：聚合所有平台和客服的数据
- 平台层：聚合该平台所有客服的数据
- 客服层：该客服的原始数据

## 测试建议

1. **功能测试**
   - 验证默认显示上周数据
   - 验证三级折叠/展开功能
   - 验证层级缩进显示正确
   - 验证数据统计准确性

2. **交互测试**
   - 点击汇总展开/折叠
   - 点击平台展开/折叠
   - 点击客服展开/折叠
   - 验证图标状态切换

3. **边界测试**
   - 无数据时的显示
   - 单个平台的显示
   - 单个客服的显示
   - 大量数据时的性能

## 相关文件

- `app/main.py` - 后端路由和数据处理逻辑
- `app/templates/tags_report.html` - 前端模板和交互逻辑
- `app/models.py` - 数据模型（TagCategory, TagDefinition, ConversationTagHit）

## 后续优化建议

1. 添加"全部展开"/"全部折叠"按钮
2. 记住用户的展开/折叠状态（localStorage）
3. 支持键盘快捷键（空格键展开/折叠）
4. 添加层级面包屑导航
5. 支持拖拽排序
