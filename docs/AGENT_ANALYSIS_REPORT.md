# 客服分析报表功能文档

## 功能概述

客服分析报表是一个多维度交叉分析工具，用于分析客服在不同时间段、不同场景和不同满意度变化下的对话数据。

## 访问路径

- **URL**: `/reports/agent-analysis`
- **权限**: 所有用户（客服只能查看自己的数据）
- **导航**: 主导航栏 → 客服分析

## 功能特点

### 1. 多维度交叉分析

报表支持以下四个维度的交叉分析：

1. **客服维度**：按站内客服用户分组
2. **时间维度**：支持按天/周/月分组
3. **场景维度**：接待场景（售前/售后/售前和售后/其他接待场景/无法判定/未知）
4. **满意度维度**：满意度变化（大幅减少/小幅减少/无显著变化/小幅增加/大幅增加/无法判定/未知）

### 2. 多级展开结构

报表采用四级树形结构展示：

```
Level 0: 客服（汇总）
  └─ Level 1: 日期（按天/周/月，汇总）
      └─ Level 2: 场景（汇总）
          └─ Level 3: 满意度（明细，可点击查看对话列表）
```

### 3. 筛选条件

- **分组方式**：按天/按周/按月
- **开始日期**：起始日期（默认：7天前）
- **结束日期**：结束日期（默认：昨天）
- **平台**：筛选特定平台（可选）
- **客服**：筛选特定客服（可选，客服角色自动限定为本人）

## 使用场景

### 1. 客服绩效分析

- 查看某个客服在特定时间段的对话数量分布
- 对比不同客服在相同场景下的表现
- 分析客服在不同场景下的擅长领域

### 2. 满意度趋势分析

- 追踪某个客服的满意度变化趋势
- 识别导致满意度下降的场景
- 评估改进措施的效果

### 3. 场景优化

- 识别高频问题场景
- 分析不同场景下的满意度分布
- 为培训提供数据支持

## 操作指南

### 基本查询

1. 访问 `/reports/agent-analysis`
2. 选择分组方式（默认按天）
3. 设置日期范围（默认最近7天）
4. 点击"查询"按钮

### 多级展开

- 点击客服名称前的 `▸` 图标展开日期明细
- 点击日期前的 `▸` 图标展开场景明细
- 点击场景前的 `▸` 图标展开满意度明细
- 再次点击 `▾` 图标折叠当前级别及所有子级

### 查看对话详情

1. 展开到满意度明细（Level 3）
2. 点击满意度标签（如"小幅增加"）
3. 弹窗显示符合条件的对话列表
4. 点击 `CID=xxxx` 可快速预览对话

## 数据说明

### 统计口径

- **对话数**：每个对话取最新一条 AI 质检结果
- **时间基准**：使用对话结束时间（如无则用开始时间或上传时间）
- **客服绑定**：优先使用客服绑定表，无绑定时使用对话表中的 `agent_user_id`

### 场景分类

根据 AI 质检结果中的 `reception_scenario` 字段：
- **售前**：咨询商品、下单等
- **售后**：退换货、投诉等
- **售前和售后**：同时涉及售前和售后
- **其他接待场景**：无法归类的场景
- **无法判定**：AI 无法判定场景
- **未知**：未进行 AI 分析或字段为空

### 满意度变化

根据 AI 质检结果中的 `satisfaction_change` 字段：
- **大幅减少**：用户满意度明显下降
- **小幅减少**：用户满意度轻微下降
- **无显著变化**：满意度基本持平
- **小幅增加**：用户满意度轻微上升
- **大幅增加**：用户满意度明显上升
- **无法判定**：AI 无法判定满意度变化
- **未知**：未进行 AI 分析或字段为空

## 权限说明

### 管理员/主管

- 可查看所有客服的数据
- 可筛选特定客服或查看全部
- 可筛选所有平台

### 客服

- 仅可查看自己的数据
- 客服筛选器自动限定为本人
- 可查看自己在不同平台的数据

## 技术实现

### 后端路由

- **页面路由**: `GET /reports/agent-analysis`
- **API 路由**: `GET /api/reports/agent-analysis/conversations`

### 数据查询

使用 PostgreSQL 的 `date_trunc` 函数实现时间分组：
- 按天：`date_trunc('day', timestamp)`
- 按周：`date_trunc('week', timestamp)`
- 按月：`date_trunc('month', timestamp)`

### 前端展示

- 采用多级树形表格结构
- 使用 JavaScript 实现展开/折叠逻辑
- 异步加载对话列表，避免一次性加载大量数据

## 常见问题

### Q: 为什么某些客服显示为"未绑定客服(ID)"？

A: 这表示该对话的 `agent_account` 尚未绑定到站内客服用户。请在"客服绑定"页面完成绑定。

### Q: 为什么某些对话显示"未知"场景或满意度？

A: 可能原因：
1. 对话尚未进行 AI 质检
2. AI 质检时未能判定场景或满意度
3. 数据导入时未包含该字段

### Q: 按周分组时，周是从哪天开始算的？

A: PostgreSQL 的 `date_trunc('week')` 默认按周一为一周的开始。

### Q: 如何导出报表数据？

A: 当前版本暂不支持导出功能，后续版本将添加 Excel 导出。

## 后续优化方向

1. **数据导出**：支持导出为 Excel/CSV 格式
2. **可视化图表**：添加柱状图、折线图等可视化展示
3. **对比分析**：支持多个客服的对比分析
4. **自定义维度**：允许用户自定义分组和统计维度
5. **定时报告**：支持定期生成并发送报表
6. **钻取功能**：支持从汇总数据钻取到对话详情

## 更新日志

### v1.0 (2026-02-02)

- 初始版本发布
- 支持客服、日期、场景、满意度四维交叉分析
- 支持按天/周/月分组
- 支持多级展开/折叠
- 支持点击查看对话列表
