# 标签报表多层折叠功能说明

## 功能概述

标签报表页面现在支持三级嵌套折叠结构，方便用户按需查看不同维度的数据。

## 访问路径

```
http://localhost:8000/reports/tags
```

## 功能特性

### 1. 默认时间维度
- **默认显示**: 上周（周一到周日）
- **可选维度**: 日、周、月、季度、年、汇总、自定义

### 2. 三级折叠结构

```
▸ 汇总                          ← 第一层：全部数据汇总
  ├─ 标签明细行...
  │
  ▸ 平台：taobao                ← 第二层：按平台汇总
    ├─ 标签明细行...
    │
    ▸ 站内客服：张三            ← 第三层：按客服明细
      └─ 标签明细行...
```

### 3. 交互方式

#### 展开/折叠
- 点击 `▸` 图标：展开该层级
- 点击 `▾` 图标：折叠该层级
- 折叠时会自动隐藏所有子级

#### 默认状态
- 页面加载时：只显示汇总 header（折叠状态）
- 所有标签明细行默认隐藏
- 需要手动展开查看详细数据

### 4. 数据展示

每个层级都包含完整的标签统计：

| 列名 | 说明 |
|------|------|
| 维度 | 显示层级名称（汇总/平台/客服） |
| 一级分类 | 标签的一级分类 |
| 二级标签 | 具体标签名称（点击查看判定标准） |
| 对话数 | 命中该标签的对话数量（点击查看 CID 列表） |
| 环比 | 与上一周期对比的变化 |
| 同比 | 与去年同期对比的变化（需勾选"同比"） |

## 使用场景

### 场景 1: 快速查看整体情况
1. 页面加载后，只显示汇总 header 行（折叠状态）
2. 点击汇总 header，展开查看汇总的标签明细和平台列表

### 场景 2: 对比不同平台
1. 点击汇总 header 展开
2. 查看汇总的标签明细和各平台的 header 行
3. 点击特定平台 header 展开查看该平台的标签明细

### 场景 3: 分析特定客服
1. 点击汇总 header 展开 → 点击平台 header 展开
2. 查看该平台的标签明细和所有客服的 header 行
3. 点击特定客服 header 展开查看该客服的标签明细

### 场景 4: 筛选特定条件
1. 使用顶部筛选器：
   - 选择时间维度（日/周/月等）
   - 选择日期范围
   - 选择平台
   - 选择站内客服
   - 勾选同比（可选）
2. 点击"刷新"按钮
3. 按需展开查看数据

## 数据说明

### 统计口径
- 每个对话只取**最新一条 AI 质检**里的命中标签
- 避免重复统计同一对话的多次质检结果

### 层级汇总规则
- **汇总层**: 所有平台、所有客服的数据总和
- **平台层**: 该平台所有客服的数据总和
- **客服层**: 该客服的原始数据

### 环比/同比计算
- **环比**: 与上一周期对比
  - 昨天 → 前天
  - 上周 → 上上周
  - 上月 → 上上月
- **同比**: 与去年同期对比（需勾选）
  - 昨天 → 去年昨天
  - 上周 → 去年上周
  - 上月 → 去年上月

## 快捷操作

### 查看标签标准
- 点击"二级标签"列的标签名称
- 弹窗显示该标签的 AI 判定标准

### 查看对话列表
- 点击"对话数"列的数字
- 弹窗显示命中该标签的所有对话 CID
- 点击 CID 可跳转到对话详情页

## 权限说明

- **管理员/主管**: 可查看所有平台和客服的数据
- **客服**: 只能查看自己的数据
- **客服**: 筛选器中的"站内客服"选项自动锁定为自己

## 性能优化

### 初始加载
- 默认折叠状态，减少初始渲染的 DOM 节点
- 提升页面加载速度

### 按需展开
- 只在用户展开时显示详细数据
- 减少浏览器内存占用

### 递归折叠
- 折叠时自动隐藏所有子级
- 避免数据混乱

## 常见问题

### Q1: 为什么默认显示上周而不是昨天？
A: 标签报表通常用于周期性分析，上周数据更完整，更适合作为默认维度。

### Q2: 如何查看昨天的数据？
A: 在"时间维度"下拉框中选择"日"，然后点击"刷新"。

### Q3: 折叠后如何快速展开所有层级？
A: 目前需要逐层展开。后续版本会添加"全部展开"按钮。

### Q4: 数据为什么是空的？
A: 可能原因：
1. 该时间段没有 AI 质检数据
2. 筛选条件过窄（如选择了不存在的平台）
3. 标签定义未激活（`is_active=False`）

### Q5: 环比/同比显示"—"是什么意思？
A: 表示上一周期或去年同期没有数据，无法计算对比。

## 技术实现

### 前端技术
- Jinja2 模板引擎
- 原生 JavaScript（无依赖）
- Tailwind CSS

### 后端技术
- FastAPI
- SQLModel (ORM)
- PostgreSQL

### 数据流
```
用户请求 → FastAPI 路由 → 数据库查询 → 数据聚合 → 模板渲染 → 前端展示
```

## 相关文档

- [CHANGELOG_TAG_REPORT_MULTILEVEL.md](../CHANGELOG_TAG_REPORT_MULTILEVEL.md) - 详细变更日志
- [TAG_MERGE_FEATURE.md](TAG_MERGE_FEATURE.md) - 标签合并功能
- [AUTO_QC_FEATURE.md](AUTO_QC_FEATURE.md) - 自动质检功能
- [IMPLEMENTATION_SUMMARY.md](IMPLEMENTATION_SUMMARY.md) - 系统实现总结

## 更新历史

- **2026-02-02**: 初始版本，实现三级折叠功能
