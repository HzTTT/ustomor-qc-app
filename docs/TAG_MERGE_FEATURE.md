# 标签合并功能说明

## 功能概述

标签合并功能允许管理员和主管将一个标签（源标签）的所有对话标记转移到另一个标签（目标标签），然后删除源标签。这在标签整理、去重、规范化时非常有用。

## 使用场景

1. **标签去重**：当发现两个标签含义重复时，可以合并为一个
   - 例如："未及时回复" 和 "回复不及时" 可以合并为一个

2. **标签规范化**：统一标签命名规范
   - 例如：将 "色差问题" 合并到 "色差/做工问题"

3. **标签重组**：调整标签分类结构
   - 例如：将旧分类下的标签合并到新分类的标签中

## 功能入口

在标签管理页面（`/settings/tags`）中：

1. 进入"全部浏览"或"分栏管理"模式
2. 找到需要合并的标签
3. 点击"编辑/停用"展开操作面板
4. 在底部找到"合并到另一个标签"区域
5. 从下拉列表中选择目标标签
6. 点击"合并到目标标签"按钮

## 操作步骤

### 1. 选择源标签和目标标签

- **源标签（A）**：需要被合并掉的标签
- **目标标签（B）**：合并后保留的标签

### 2. 确认合并操作

系统会弹出确认对话框：
```
确定要合并吗？

将把「源标签名」的所有对话标记转移到目标标签，然后删除「源标签名」。
此操作不可恢复。
```

### 3. 执行合并

点击确认后，系统会执行以下操作：

#### 3.1 迁移 AI 自动命中记录（ConversationTagHit）
- 查找所有源标签的命中记录
- 对于每条记录：
  - 如果目标标签在同一对话分析中已存在命中记录，删除源标签记录（去重）
  - 如果目标标签在该对话分析中不存在，将源标签记录的 `tag_id` 改为目标标签 ID（迁移）

#### 3.2 迁移手动标记（ManualTagBinding）
- 查找所有源标签的手动标记
- 对于每条记录：
  - 如果目标标签在同一对话中已存在手动标记，删除源标签记录（去重）
  - 如果目标标签在该对话中不存在，将源标签记录的 `tag_id` 改为目标标签 ID（迁移）

#### 3.3 删除源标签
- 删除源标签定义（TagDefinition）

### 4. 查看结果

合并完成后，系统会显示操作结果：
```
已合并：源标签名 → 目标标签名；
迁移命中X条（去重Y条），迁移手动标记M条（去重N条）
```

## 技术实现

### 后端路由

**端点**：`POST /settings/tags/tag/merge`

**参数**：
- `source_tag_id`: 源标签 ID（必填）
- `target_tag_id`: 目标标签 ID（必填）
- `ui_cat`: 当前分类 ID（可选，用于页面导航）
- `ui_view`: 视图模式（可选，用于页面导航）

**权限**：管理员（admin）或主管（supervisor）

### 数据库操作

```python
# 1. 迁移 ConversationTagHit
for hit in source_hits:
    existing = check_if_target_tag_exists_for_same_analysis()
    if existing:
        delete(hit)  # 去重
    else:
        hit.tag_id = target_tag_id  # 迁移

# 2. 迁移 ManualTagBinding
for binding in source_bindings:
    existing = check_if_target_tag_exists_for_same_conversation()
    if existing:
        delete(binding)  # 去重
    else:
        binding.tag_id = target_tag_id  # 迁移

# 3. 删除源标签
delete(source_tag)
```

### 前端界面

在标签操作面板中添加了合并表单：
- 下拉选择器：按分类分组显示所有标签（排除当前标签）
- 必填验证：必须选择目标标签才能提交
- 确认提示：防止误操作

## 注意事项

### ⚠️ 不可逆操作

标签合并是**不可恢复**的操作，请在执行前：
1. 确认源标签和目标标签的选择正确
2. 了解两个标签的含义和用途
3. 必要时先导出标签配置作为备份

### 🔄 自动去重

- 如果同一对话分析/对话已经同时被源标签和目标标签标记，合并时会自动去重
- 去重时保留目标标签的记录，删除源标签的记录
- 去重数量会在操作结果中显示

### 📊 影响范围

合并操作会影响：
1. **报表统计**：所有使用该标签的报表会转为显示目标标签
2. **历史记录**：过去被源标签标记的对话，现在会显示目标标签
3. **标签建议**：如果有待审批的标签建议指向源标签，需要手动处理

### 🚫 限制条件

- 不能将标签合并到自己
- 源标签和目标标签必须都存在
- 需要管理员或主管权限

## 相关功能

- **停用标签**：`POST /settings/tags/tag/delete` - 软删除，标签仍存在但不再使用
- **彻底删除标签**：`POST /settings/tags/tag/remove` - 硬删除，同时删除所有命中记录和手动标记
- **批量导入标签**：`POST /settings/tags/import` - 支持覆盖导入模式

## 最佳实践

### 1. 合并前规划

在执行合并前，建议：
- 列出需要合并的标签清单
- 确定标签层次结构和命名规范
- 与团队成员沟通确认

### 2. 分批处理

对于大量标签合并：
- 先处理同一分类内的标签
- 逐步推进，每次合并后检查结果
- 避免一次性大量操作

### 3. 记录变更

建议保留合并记录：
- 记录合并的源标签和目标标签
- 记录合并原因和时间
- 方便后续追溯和团队知识传承

### 4. 验证结果

合并后验证：
- 在报表页面检查标签统计是否正确
- 查看几个典型对话，确认标签显示正确
- 检查是否有遗漏或异常情况

## 故障排查

### Q: 合并后对话没有显示目标标签？

A: 可能的原因：
1. 浏览器缓存，刷新页面试试
2. 对话分析记录为空，需要重新触发 AI 分析
3. 检查目标标签是否处于"停用"状态

### Q: 合并失败提示"标签不存在"？

A: 检查：
1. 源标签和目标标签是否都存在且未被删除
2. 是否有足够的权限（需要 admin 或 supervisor 角色）
3. 查看应用日志获取详细错误信息

### Q: 合并操作可以撤销吗？

A: 不能自动撤销，但可以手动恢复：
1. 重新创建被删除的源标签
2. 使用批量导入功能从备份恢复
3. 必要时联系技术人员通过数据库操作恢复

## 版本历史

- **v1.0** (2026-01-30): 初始版本，支持基本的标签合并功能
  - 迁移 AI 自动命中记录
  - 迁移手动标记
  - 自动去重
  - 操作结果统计
