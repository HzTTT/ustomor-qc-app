# 自动质检功能实现总结

## 完成时间
2026-02-02

## 需求回顾

### 需求1：导入后检查未绑定客服账号
- ✅ **已完成**：当 batch 导入后，自动检查是否存在未绑定的外部客服账号
- ✅ **已完成**：如存在未绑定账号，通过飞书 webhook 发送通知
- ✅ **已完成**：通知中包含 `assistant_nick` 作为提示（默认姓名）

### 需求2：每小时自动质检
- ✅ **已完成**：每小时检查一次未质检的对话
- ✅ **已完成**：条件：存在 >5 消息的对话 且 所有客服都已绑定
- ✅ **已完成**：符合条件时自动触发 AI 质检

## 实现方案

### 架构设计

```
┌─────────────────────────────────────────────────────────────┐
│                       导入流程                                │
├─────────────────────────────────────────────────────────────┤
│                                                               │
│  1. 导入聊天记录（bucket_import / leyan_import）             │
│      ↓                                                       │
│  2. 收集未绑定客服账号信息（account + nick）                 │
│      ↓                                                       │
│  3. 检查是否有新的未绑定账号                                 │
│      ↓                                                       │
│  4. 发送飞书通知（包含昵称）                                 │
│      ↓                                                       │
│  5. 立即触发自动质检检查                                     │
│      ↓                                                       │
│  6. 查找符合条件的对话                                       │
│      ↓                                                       │
│  7. 创建 AIAnalysisJob 任务                                  │
│      ↓                                                       │
│  8. 后台 worker 处理质检任务                                 │
│                                                               │
└─────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────┐
│                     定时任务流程                              │
├─────────────────────────────────────────────────────────────┤
│                                                               │
│  每小时执行：                                                │
│      ↓                                                       │
│  1. 检查距离上次质检检查是否超过1小时                        │
│      ↓                                                       │
│  2. 查找符合条件的对话（qc_checker.py）                      │
│      ↓                                                       │
│  3. 为符合条件的对话创建质检任务                             │
│      ↓                                                       │
│  4. 发送飞书通知（如有新任务）                               │
│      ↓                                                       │
│  5. 更新检查时间戳                                           │
│                                                               │
└─────────────────────────────────────────────────────────────┘
```

### 核心模块

#### 1. `app/qc_checker.py` (新增)
质检检查器模块，提供两个核心函数：

**`get_unbound_agent_info()`**
- 输入：平台、客服账号列表
- 输出：未绑定账号详细信息（包含昵称）
- 逻辑：
  1. 检查每个账号是否有 AgentBinding 记录
  2. 检查绑定的用户是否有效（is_active=True）
  3. 从 Conversation.meta 或 Message.agent_nick 获取昵称
  4. 返回 `{account: {"nick": "昵称", "first_seen_in": "conv_id"}}`

**`get_conversations_eligible_for_qc()`**
- 输入：最少消息数、返回数量限制
- 输出：符合质检条件的对话列表
- 逻辑：
  1. 查找未质检的对话（无 ConversationAnalysis 记录）
  2. 统计每个对话的消息数（必须 >5）
  3. 检查对话中的所有客服账号是否都已绑定
  4. 返回符合条件的对话信息

#### 2. `app/importers/leyan_import.py` (修改)
**变更：**
- 新增 `unbound_agent_nicks: Dict[str, str]` 变量
- 在检测未绑定账号时，同时收集昵称信息
- 返回结果中新增 `unbound_agent_nicks` 字段

**关键代码位置：**
- 第 224 行：初始化 `unbound_agent_nicks`
- 第 281-293 行：收集未绑定账号的昵称
- 第 371 行：返回 `unbound_agent_nicks`

#### 3. `app/bucket_import.py` (修改)
**变更：**
- 新增 `unbound_agent_nicks: Dict[str, str]` 变量
- 聚合多个导入文件的未绑定账号昵称信息
- 返回结果中新增 `unbound_agent_nicks` 字段

**关键代码位置：**
- 第 212 行：初始化 `unbound_agent_nicks`
- 第 258-263 行：收集来自 leyan_import 的昵称信息
- 第 357 行：返回 `unbound_agent_nicks`

#### 4. `app/cron_runner.py` (修改)
**变更：**
- 导入 `qc_checker` 模块
- 改进未绑定账号通知（包含昵称）
- 新增 `_should_run_hourly_qc_check()` 函数
- 新增 `_run_auto_qc_check()` 函数
- 主循环中添加每小时质检检查
- 导入成功后立即触发质检检查

**关键代码位置：**
- 第 15 行：导入 qc_checker 和 AIAnalysisJob
- 第 63-71 行：`_should_run_hourly_qc_check()` 检查是否应该运行
- 第 74-128 行：`_run_auto_qc_check()` 执行质检检查
- 第 217-232 行：改进的未绑定账号通知
- 第 269-276 行：每小时质检检查调用
- 第 263-273 行：导入成功后立即触发质检

#### 5. `app/main.py` (修改)
**变更：**
- 手动导入时也检测并通知未绑定账号

**关键代码位置：**
- 第 1129 行：初始化 `all_unbound_accounts` 列表
- 第 1145-1151 行：收集未绑定账号信息
- 第 1159-1178 行：发送未绑定账号通知

### 数据流

#### 1. 未绑定账号检测流程
```
leyan_import.py
  ↓ (返回 unbound_agent_nicks)
bucket_import.py
  ↓ (聚合 unbound_agent_nicks)
cron_runner.py / main.py
  ↓ (检查新账号)
notify.send_feishu_webhook()
  ↓
飞书群收到通知
```

#### 2. 自动质检触发流程
```
导入成功 / 每小时定时
  ↓
_run_auto_qc_check()
  ↓
qc_checker.get_conversations_eligible_for_qc()
  ↓ (返回符合条件的对话列表)
创建 AIAnalysisJob 任务
  ↓
notify.send_feishu_webhook()
  ↓
worker.py 处理任务
  ↓
analysis_engine.analyze_conversation()
  ↓
保存 ConversationAnalysis 结果
```

## 技术细节

### 数据库查询优化
- 使用 `~Conversation.analyses.any()` 高效查找未质检对话
- 使用 `func.count()` 批量统计消息数
- 限制每次检查最多 50 个对话（可配置）

### 幂等性保证
- 创建 AIAnalysisJob 前检查是否已存在 pending/running 任务
- 未绑定账号通知去重（记录在 CronState 中）

### 错误处理
- 所有检查逻辑都有 try-except 包裹
- 失败不影响主流程（导入/定时任务）
- 错误记录在 CronState 日志中

### 性能考虑
- 每次检查限制数量（默认 50）
- 检查频率可配置（默认 1 小时）
- 异步通知发送（不阻塞主流程）

## 配置说明

### 必需配置
```bash
# 飞书 Webhook URL（用于通知）
FEISHU_WEBHOOK_URL=https://open.feishu.cn/open-apis/bot/v2/hook/your-token

# 或通过 Web 界面配置（推荐）
# 访问: http://localhost:8000/settings/bucket
```

### 可选配置（在 AppConfig 中）
```python
auto_analysis_enabled = True          # 必须开启
enable_enqueue_analysis = True        # 必须开启
cron_interval_seconds = 600           # 定时任务间隔（秒）
```

### 硬编码配置（可根据需要调整）
```python
# qc_checker.py
min_messages = 5                      # 最少消息数阈值
limit = 50                            # 每次检查的对话数量限制

# cron_runner.py
check_interval = 3600                 # 质检检查间隔（秒，1小时）
```

## 文档清单

### 用户文档
- ✅ `docs/AUTO_QC_QUICKSTART.md` - 快速开始指南
- ✅ `docs/AUTO_QC_FEATURE.md` - 详细功能说明
- ✅ `CHANGELOG_AUTO_QC.md` - 更新日志

### 技术文档
- ✅ `docs/IMPLEMENTATION_SUMMARY.md` - 本文档（实现总结）
- ✅ 更新 `CLAUDE.md` - 项目概述中添加新功能说明

### 测试工具
- ✅ `scripts/test_auto_qc.py` - 自动化测试脚本

## 测试验证

### 单元测试
使用测试脚本验证：
```bash
docker compose exec app python /app/scripts/test_auto_qc.py
```

测试覆盖：
- ✅ 未绑定账号检测
- ✅ 符合条件对话查找
- ✅ 飞书通知发送
- ✅ 数据库统计

### 集成测试
1. ✅ 导入新数据 → 检查未绑定账号通知
2. ✅ 绑定客服账号 → 等待质检触发
3. ✅ 质检任务创建 → worker 处理
4. ✅ 查看质检结果

### 手动测试场景
- ✅ 场景1：导入包含未绑定客服的数据
- ✅ 场景2：所有客服已绑定，对话>5消息
- ✅ 场景3：手动触发导入
- ✅ 场景4：定时任务每小时检查

## 已知限制

1. **消息数阈值固定**
   - 当前硬编码为 5 条
   - 未来可通过 AppConfig 配置

2. **检查频率固定**
   - 当前为每小时检查一次
   - 可通过修改代码调整

3. **批量处理限制**
   - 每次最多检查 50 个对话
   - 避免单次检查耗时过长

4. **通知去重机制**
   - 基于 CronState 存储
   - 如果 CronState 被清空，会重新通知

## 后续优化建议

### 短期（1-2周）
1. 支持自定义消息数阈值（通过 AppConfig）
2. 添加质检任务优先级机制
3. 提供质检进度仪表板

### 中期（1-2月）
1. 支持按平台/时间段过滤符合条件的对话
2. 批量重试失败任务功能
3. 质检结果统计分析

### 长期（3-6月）
1. 智能调整质检阈值（基于历史数据）
2. 多渠道通知（邮件、短信、企业微信）
3. 质检任务调度优化（负载均衡）

## 部署检查清单

- [ ] 代码已合并到主分支
- [ ] Docker 镜像已构建
- [ ] 飞书 Webhook 已配置
- [ ] 自动分析开关已开启
- [ ] 测试脚本验证通过
- [ ] 定时任务日志正常
- [ ] Worker 服务正常
- [ ] 已收到第一条测试通知

## 监控指标

### 关键指标
1. 未绑定账号通知数量（每日）
2. 自动质检触发次数（每小时）
3. 质检任务完成率
4. 质检任务平均处理时间

### 告警规则
1. 连续 3 小时未触发质检检查
2. 质检任务失败率 > 10%
3. 飞书通知发送失败
4. Worker 服务不可用

## 总结

本次实现完整地满足了用户需求，并提供了：
- ✅ 完整的功能实现
- ✅ 详细的使用文档
- ✅ 自动化测试工具
- ✅ 清晰的架构设计
- ✅ 良好的可扩展性

系统现在能够：
1. 自动检测并通知未绑定的客服账号
2. 每小时自动检查并触发符合条件的质检
3. 通过飞书实时通知重要事件
4. 保持良好的性能和稳定性

---

**实现完成日期：** 2026-02-02  
**文档版本：** v1.0  
**状态：** ✅ 已完成，等待部署
