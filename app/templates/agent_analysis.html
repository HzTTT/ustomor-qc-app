{% extends "base.html" %}
{% block content %}
<div class="flex items-start justify-between gap-4 mb-4">
  <div>
    <h1 class="text-2xl font-semibold">客服分析报表</h1>
    <div class="text-sm text-slate-500 mt-1">多维度交叉分析：客服 → 日期 → 场景 → 满意度</div>
  </div>
</div>

<div class="bg-white border rounded-2xl p-4">
  <form method="get" action="/reports/agent-analysis" class="grid grid-cols-1 md:grid-cols-6 gap-2 items-end">
    <div>
      <label class="block text-xs text-slate-500 mb-1">分组方式</label>
      <select name="group_by" class="w-full border rounded-xl px-3 py-2 text-sm">
        {% for k, label in group_by_options %}
          <option value="{{ k }}" {% if k == filters.group_by %}selected{% endif %}>{{ label }}</option>
        {% endfor %}
      </select>
    </div>
    <div>
      <label class="block text-xs text-slate-500 mb-1">开始日期</label>
      <input type="date" name="start" value="{{ filters.start }}" class="w-full border rounded-xl px-3 py-2 text-sm" />
    </div>
    <div>
      <label class="block text-xs text-slate-500 mb-1">结束日期</label>
      <input type="date" name="end" value="{{ filters.end }}" class="w-full border rounded-xl px-3 py-2 text-sm" />
    </div>
    <div>
      <label class="block text-xs text-slate-500 mb-1">平台</label>
      <select name="platform" class="w-full border rounded-xl px-3 py-2 text-sm">
        <option value="">全部</option>
        {% for p in platform_options %}
          <option value="{{ p }}" {% if p == filters.platform %}selected{% endif %}>{{ p }}</option>
        {% endfor %}
      </select>
    </div>
    <div>
      <label class="block text-xs text-slate-500 mb-1">客服</label>
      <select name="agent_user_id" class="w-full border rounded-xl px-3 py-2 text-sm">
        <option value="">全部</option>
        {% for u in agent_options %}
          <option value="{{ u.id }}" {% if (filters.agent_user_id|string) == (u.id|string) %}selected{% endif %}>{{ u.label }}</option>
        {% endfor %}
      </select>
    </div>
    <div>
      <button type="submit" class="w-full px-4 py-2 rounded-xl bg-slate-900 text-white text-sm hover:bg-slate-800">查询</button>
    </div>
  </form>
</div>

<div class="mt-4 bg-white border rounded-2xl p-4">
  {% if table_rows|length == 0 %}
    <div class="text-sm text-slate-500">暂无数据（可能是还没有AI分析，或筛选条件过窄）</div>
  {% else %}
    <div class="overflow-x-auto">
      <table class="min-w-full text-sm">
        <thead>
          <tr class="text-left border-b">
            <th class="py-2 pr-4">维度</th>
            <th class="py-2 pr-4">对话数</th>
          </tr>
        </thead>
        <tbody>
          {% for r in table_rows %}
            <tr class="border-b {% if r.is_header %}bg-slate-50 font-medium{% endif %}" 
                data-row-id="{{ r.group_id }}-{% if r.is_header %}header{% else %}{{ loop.index }}{% endif %}"
                data-level="{{ r.level }}"
                data-parent="{{ r.parent_id }}"
                data-group="{{ r.group_id }}"
                data-is-header="{{ r.is_header }}">
              <td class="py-2 pr-4">
                {% if r.is_header %}
                  <button type="button" class="text-left w-full" onclick="toggleGroup('{{ r.group_id }}')" style="padding-left: {{ r.level * 20 }}px;">
                    <span id="ico-{{ r.group_id }}">▾</span> {{ r.label }}
                  </button>
                {% else %}
                  <div style="padding-left: {{ r.level * 20 + 20 }}px;">
                    <button type="button" 
                            class="text-blue-600 hover:underline text-left"
                            data-agent-id="{{ r.agent_id }}"
                            data-period="{{ r.period }}"
                            data-scenario="{{ r.scenario }}"
                            data-satisfaction="{{ r.satisfaction }}"
                            data-platform="{{ filters.platform }}"
                            onclick="showConversations(this)">
                      {{ r.label }}
                    </button>
                  </div>
                {% endif %}
              </td>
              <td class="py-2 pr-4">
                {% if r.is_header %}
                  <span class="font-semibold">{{ r.count }}</span>
                {% else %}
                  {{ r.count }}
                {% endif %}
              </td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  {% endif %}
</div>

<!-- Conversation List Modal -->
<div id="conv-list-modal" class="fixed inset-0 hidden items-center justify-center bg-black/40 z-50">
  <div class="bg-white rounded-2xl p-4 w-full max-w-2xl border max-h-[80vh] flex flex-col">
    <div class="flex items-start justify-between gap-3 mb-3">
      <div>
        <div id="conv-list-title" class="font-semibold">对话列表</div>
        <div id="conv-list-subtitle" class="text-xs text-slate-500 mt-1"></div>
      </div>
      <button type="button" class="px-3 py-1.5 rounded-lg bg-white border text-sm" onclick="closeConvList()">关闭</button>
    </div>
    <div id="conv-list-loading" class="text-sm text-slate-500">加载中...</div>
    <div id="conv-list-content" class="overflow-y-auto flex-1 text-sm flex flex-wrap gap-2 hidden"></div>
  </div>
</div>

<script>
  function toggleGroup(groupId) {
    const ico = document.getElementById('ico-' + groupId);
    const isExpanded = ico && ico.textContent === '▾';
    
    if (isExpanded) {
      // 折叠：隐藏当前组的明细行和所有子元素
      const detailRows = document.querySelectorAll('[data-group="' + groupId + '"][data-is-header="False"]');
      detailRows.forEach(row => row.classList.add('hidden'));
      
      const allChildren = document.querySelectorAll('[data-parent="' + groupId + '"]');
      allChildren.forEach(child => {
        child.classList.add('hidden');
        const childGroupId = child.getAttribute('data-group');
        const childIco = document.getElementById('ico-' + childGroupId);
        if (childIco) {
          childIco.textContent = '▸';
        }
        hideAllDescendants(childGroupId);
      });
      
      if (ico) ico.textContent = '▸';
    } else {
      // 展开：显示当前组的明细行和直接子 header
      const detailRows = document.querySelectorAll('[data-group="' + groupId + '"][data-is-header="False"]');
      detailRows.forEach(row => row.classList.remove('hidden'));
      
      const directChildren = document.querySelectorAll('[data-parent="' + groupId + '"][data-is-header="True"]');
      directChildren.forEach(child => child.classList.remove('hidden'));
      
      if (ico) ico.textContent = '▾';
    }
  }
  
  function hideAllDescendants(parentId) {
    const detailRows = document.querySelectorAll('[data-group="' + parentId + '"][data-is-header="False"]');
    detailRows.forEach(row => row.classList.add('hidden'));
    
    const children = document.querySelectorAll('[data-parent="' + parentId + '"]');
    children.forEach(child => {
      child.classList.add('hidden');
      const childGroupId = child.getAttribute('data-group');
      const childIco = document.getElementById('ico-' + childGroupId);
      if (childIco) {
        childIco.textContent = '▸';
      }
      hideAllDescendants(childGroupId);
    });
  }

  async function showConversations(btn) {
    const agentId = btn.getAttribute('data-agent-id');
    const period = btn.getAttribute('data-period');
    const scenario = btn.getAttribute('data-scenario');
    const satisfaction = btn.getAttribute('data-satisfaction');
    const platform = btn.getAttribute('data-platform');
    
    const params = new URLSearchParams();
    if (agentId) params.append('agent_id', agentId);
    params.append('period', period);
    params.append('scenario', scenario);
    params.append('satisfaction', satisfaction);
    if (platform) params.append('platform', platform);
    
    const modal = document.getElementById('conv-list-modal');
    const loading = document.getElementById('conv-list-loading');
    const content = document.getElementById('conv-list-content');
    const title = document.getElementById('conv-list-title');
    const subtitle = document.getElementById('conv-list-subtitle');
    
    modal.classList.remove('hidden');
    modal.classList.add('flex');
    loading.classList.remove('hidden');
    content.classList.add('hidden');
    
    subtitle.textContent = `场景: ${scenario}, 满意度: ${satisfaction}, 日期: ${period}`;
    
    try {
      const response = await fetch('/api/reports/agent-analysis/conversations?' + params.toString());
      const data = await response.json();
      
      if (data.error) {
        content.innerHTML = '<div class="text-sm text-red-600">' + data.error + '</div>';
      } else if (data.cids.length === 0) {
        content.innerHTML = '<div class="text-sm text-slate-500">暂无数据</div>';
      } else {
        title.textContent = `对话列表（共 ${data.cids.length} 个）`;
        content.innerHTML = data.cids.map(cid => 
          `<a href="#" class="cid-link text-blue-600 hover:underline" data-cid="${cid}">CID=${cid}</a>`
        ).join(' ');
      }
      
      loading.classList.add('hidden');
      content.classList.remove('hidden');
    } catch (error) {
      content.innerHTML = '<div class="text-sm text-red-600">加载失败：' + error.message + '</div>';
      loading.classList.add('hidden');
      content.classList.remove('hidden');
    }
  }
  
  function closeConvList() {
    const modal = document.getElementById('conv-list-modal');
    modal.classList.add('hidden');
    modal.classList.remove('flex');
  }
  
  document.getElementById('conv-list-modal')?.addEventListener('click', function(e){
    if (e.target && e.target.id === 'conv-list-modal') closeConvList();
  });
</script>

{% endblock %}
