{% extends "base.html" %}
{% block content %}
<div class="flex items-start justify-between gap-4 mb-4">
  <div>
    <h1 class="text-2xl font-semibold">标签报表</h1>
    <div class="text-sm text-slate-500 mt-1">统计口径：每个对话只取最新一条 AI质检里的命中标签。</div>
  </div>
  {% if user.role in ["admin", "supervisor"] %}
    <a href="/settings/tags" class="px-3 py-2 rounded-xl bg-white border text-sm hover:bg-slate-50">去标签管理</a>
  {% endif %}
</div>

{% if flash %}
  <div class="mb-4 p-3 rounded-xl border bg-slate-900 text-white text-sm">{{ flash }}</div>
{% endif %}

<div class="lg:grid lg:grid-cols-[16rem_minmax(0,1fr)] lg:gap-6">
  <div id="pivot-sidebar" class="bg-white border rounded-2xl p-4 shadow-sm mb-4 lg:mb-0 lg:sticky lg:top-24 lg:self-start">
    <div class="flex items-start justify-between gap-3">
      <div>
        <div class="font-medium">行维度</div>
        <div class="text-xs text-slate-500 mt-1">拖拽选择并排序：报表会按这些维度逐层分组。系统会自动补充「标签一级分类/标签」。</div>
      </div>
    </div>
    <div class="mt-3 rounded-xl border bg-slate-50">
      <div class="p-3 space-y-3">
        <div class="flex items-center justify-between gap-2">
          <div class="text-xs font-medium text-slate-700">展开/收起表格</div>
          <div class="text-[11px] text-slate-500">也可在表格里点 ▸</div>
        </div>

        <div class="flex items-center justify-between gap-2">
          <div class="text-xs text-slate-600 shrink-0">全部</div>
          <div class="inline-flex rounded-xl border bg-white overflow-hidden">
            <button id="expand-all" type="button" class="px-3 py-2 text-xs hover:bg-slate-50 focus:outline-none focus:ring-2 focus:ring-slate-200">展开</button>
            <div class="w-px bg-slate-200"></div>
            <button id="collapse-all" type="button" class="px-3 py-2 text-xs hover:bg-slate-50 focus:outline-none focus:ring-2 focus:ring-slate-200">收起</button>
          </div>
        </div>

        <div class="space-y-2">
          <label for="level-select" class="block text-xs text-slate-600">当前层级</label>
          <select id="level-select" class="border rounded-xl px-3 py-2 text-xs w-full bg-white focus:outline-none focus:ring-2 focus:ring-slate-200"></select>
          <div class="flex items-center justify-between gap-2">
            <div class="text-xs text-slate-600 shrink-0">本层</div>
            <div class="inline-flex rounded-xl border bg-white overflow-hidden">
              <button id="expand-level" type="button" class="px-3 py-2 text-xs hover:bg-slate-50 focus:outline-none focus:ring-2 focus:ring-slate-200 disabled:opacity-40 disabled:cursor-not-allowed">展开</button>
              <div class="w-px bg-slate-200"></div>
              <button id="collapse-level" type="button" class="px-3 py-2 text-xs hover:bg-slate-50 focus:outline-none focus:ring-2 focus:ring-slate-200 disabled:opacity-40 disabled:cursor-not-allowed">收起</button>
            </div>
          </div>
          <div id="level-hint" class="text-[11px] text-slate-500"></div>
        </div>
      </div>
    </div>
    <div class="mt-4">
      <div class="text-xs text-slate-500 mb-1">已选维度（行）</div>
      <div id="row-fields" class="min-h-[52px] flex flex-wrap gap-2 p-2 border rounded-xl bg-slate-50" data-list="active"></div>
    </div>
    <div class="mt-3">
      <div class="text-xs text-slate-500 mb-1">可选维度</div>
      <div id="available-fields" class="min-h-[52px] flex flex-wrap gap-2 p-2 border rounded-xl bg-slate-50" data-list="available"></div>
    </div>
    <div class="mt-3 text-xs text-slate-500">提示：每一层都会自动带上「标签一级分类」和「标签」。手机端可长按维度标签拖拽排序/移动。</div>
  </div>

  <div class="min-w-0">
    <div class="bg-white border rounded-2xl p-4" id="pivot-filter-card">
  <form id="pivot-filters" class="grid grid-cols-1 md:grid-cols-12 gap-2 items-end" onsubmit="return false;">
    <div class="md:col-span-2">
      <label class="block text-xs text-slate-500 mb-1">时间维度</label>
      <select id="time-mode" class="w-full border rounded-xl px-3 py-2 text-sm">
        {% for k, label in time_modes %}
          <option value="{{ k }}" {% if k == filters.time_mode %}selected{% endif %}>{{ label }}</option>
        {% endfor %}
      </select>
    </div>
    <div id="year-wrap" class="md:col-span-2">
      <label class="block text-xs text-slate-500 mb-1">年份</label>
      <select id="year-select" class="w-full border rounded-xl px-3 py-2 text-sm"></select>
    </div>
    <div id="quarter-wrap" class="md:col-span-2">
      <label class="block text-xs text-slate-500 mb-1">季度</label>
      <select id="quarter-select" class="w-full border rounded-xl px-3 py-2 text-sm"></select>
    </div>
    <div id="month-wrap" class="md:col-span-2">
      <label class="block text-xs text-slate-500 mb-1">月份</label>
      <select id="month-select" class="w-full border rounded-xl px-3 py-2 text-sm"></select>
    </div>
    <div id="week-wrap" class="md:col-span-2">
      <label class="block text-xs text-slate-500 mb-1">周次</label>
      <select id="week-select" class="w-full border rounded-xl px-3 py-2 text-sm"></select>
    </div>
    <div id="day-wrap" class="md:col-span-2">
      <label class="block text-xs text-slate-500 mb-1">日期</label>
      <input type="date" id="day-select" class="w-full border rounded-xl px-3 py-2 text-sm" />
    </div>
    <div id="custom-start-wrap" class="md:col-span-2">
      <label class="block text-xs text-slate-500 mb-1">起始</label>
      <input type="date" id="start-date" value="{{ filters.start }}" class="w-full border rounded-xl px-3 py-2 text-sm" />
    </div>
    <div id="custom-end-wrap" class="md:col-span-2">
      <label class="block text-xs text-slate-500 mb-1">结束</label>
      <input type="date" id="end-date" value="{{ filters.end }}" class="w-full border rounded-xl px-3 py-2 text-sm" />
    </div>
    <div class="md:col-span-3">
      <label class="block text-xs text-slate-500 mb-1">平台</label>
      <select id="platform-filter" class="w-full border rounded-xl px-3 py-2 text-sm">
        <option value="">全部</option>
        {% for p in platform_options %}
          <option value="{{ p }}" {% if p == filters.platform %}selected{% endif %}>{{ p }}</option>
        {% endfor %}
      </select>
    </div>
    <div class="md:col-span-3">
      <label class="block text-xs text-slate-500 mb-1">站内客服</label>
      <select id="agent-filter" class="w-full border rounded-xl px-3 py-2 text-sm">
        <option value="">全部</option>
        {% for u in agent_options %}
          <option value="{{ u.id }}" {% if (filters.agent_user_id|string) == (u.id|string) %}selected{% endif %}>{{ u.label }}</option>
        {% endfor %}
      </select>
    </div>
    <div class="md:col-span-3">
      <label class="block text-xs text-slate-500 mb-1">接待场景</label>
      <select id="scenario-filter" class="w-full border rounded-xl px-3 py-2 text-sm">
        <option value="">全部</option>
        <option value="售前">售前</option>
        <option value="售后">售后</option>
        <option value="售前和售后">售前和售后</option>
        <option value="其他接待场景">其他接待场景</option>
        <option value="无法判定">无法判定</option>
        <option value="未知">未知</option>
      </select>
    </div>
    <div class="md:col-span-3">
      <label class="block text-xs text-slate-500 mb-1">满意度变化</label>
      <select id="satisfaction-filter" class="w-full border rounded-xl px-3 py-2 text-sm">
        <option value="">全部</option>
        <option value="大幅减少">大幅减少</option>
        <option value="小幅减少">小幅减少</option>
        <option value="无显著变化">无显著变化</option>
        <option value="小幅增加">小幅增加</option>
        <option value="大幅增加">大幅增加</option>
        <option value="无法判定">无法判定</option>
        <option value="未知">未知</option>
      </select>
    </div>
  </form>
  <div class="mt-3 flex flex-wrap items-center gap-2">
    <button id="toggle-mom" type="button" class="px-2.5 py-1 rounded-lg border text-xs">环比</button>
    <button id="toggle-yoy" type="button" class="px-2.5 py-1 rounded-lg border text-xs">同比</button>
    <button id="manual-refresh" type="button" class="px-3 py-1.5 rounded-lg bg-slate-900 text-white text-sm">刷新</button>
    <div id="period-label" class="text-xs text-slate-500"></div>
  </div>
    </div>

    <div class="mt-4 bg-white border rounded-2xl p-4">
      <div id="pivot-loading" class="text-sm text-slate-500">加载中...</div>
      <div id="pivot-empty" class="text-sm text-slate-500 hidden">暂无数据（可能是还没有AI命中标签，或筛选条件过窄）</div>
      <div class="overflow-x-auto pb-2">
        <style>
          /* 标签报表：突出4列主指标，弱化环比/同比列，减少拥挤感 */
          #pivot-table {
            width: 100%;
            min-width: 0;
            table-layout: fixed;
          }
          #pivot-table thead th {
            white-space: normal;
            line-height: 1.15;
          }
          #pivot-table th.dim-col,
          #pivot-table td.dim-col {
            width: clamp(190px, 20vw, 240px);
            min-width: 190px;
            max-width: 240px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            position: sticky;
            left: 0;
            z-index: 12;
            border-right: 1px solid #e2e8f0;
          }
          #pivot-table thead th.dim-col {
            background: #ffffff;
          }
          #pivot-table tbody td.dim-col {
            background: #ffffff;
          }
          #pivot-table tbody tr.bg-slate-50 td.dim-col {
            background: #f8fafc;
          }
          #pivot-table th.col-main {
            background: rgba(248, 250, 252, 0.9);
            font-weight: 700;
            color: #0f172a;
          }
          #pivot-table td.col-main {
            font-weight: 600;
            color: #0f172a;
          }
          #pivot-table .col-group-start {
            border-left: 1px solid #e2e8f0;
            padding-left: 0.5rem;
          }
          #pivot-table th.col-delta,
          #pivot-table td.col-delta {
            font-size: 12px;
            color: #64748b;
            font-variant-numeric: tabular-nums;
            white-space: nowrap;
            width: 60px;
            min-width: 60px;
            padding-right: 0.5rem;
          }
          #pivot-table th.col-delta {
            font-size: 11px;
            letter-spacing: 0.02em;
          }
          #pivot-table th.col-main,
          #pivot-table td.col-main {
            width: 96px;
            min-width: 96px;
          }
          #pivot-table td.dim-col button,
          #pivot-table td.dim-col a,
          #pivot-table td.dim-col span {
            white-space: nowrap;
          }
          @media (max-width: 1024px) {
            #pivot-table th.dim-col,
            #pivot-table td.dim-col {
              width: 180px;
              min-width: 180px;
              max-width: 200px;
            }
            #pivot-table th.col-main,
            #pivot-table td.col-main {
              width: 88px;
              min-width: 88px;
            }
            #pivot-table th.col-delta,
            #pivot-table td.col-delta {
              width: 54px;
              min-width: 54px;
            }
          }

          /* 移动端：字段拖拽（Pointer Events） */
          #row-fields.is-drop-target,
          #available-fields.is-drop-target {
            outline: 2px dashed rgba(15, 23, 42, 0.35);
            outline-offset: 2px;
          }
          .chip-drag-source {
            opacity: 0.35;
          }
          .chip-drag-ghost {
            position: fixed;
            z-index: 9999;
            pointer-events: none;
            box-shadow: 0 14px 34px rgba(2, 6, 23, 0.24);
            opacity: 0.95;
          }
        </style>
        <table class="min-w-full text-sm" id="pivot-table">
          <thead>
            <tr class="text-left border-b">
              <th class="py-2 pr-4 dim-col">维度</th>
              <th class="py-2 pr-4 col-main col-group-start" title="质检对话数（去重）：在当前行维度范围内的去重对话数（按对话ID去重；每个对话只取最新一条AI质检分析）。标签/标签分类行则表示命中该标签范围内的去重对话数。">质检对话数</th>
              <th class="py-2 pr-4 col-mom col-delta" title="质检对话数环比">环比</th>
              <th class="py-2 pr-4 col-yoy col-delta" title="质检对话数同比">同比</th>
              <th class="py-2 pr-4 col-main col-group-start" title="对话数占比 = 质检对话数（去重） / 总质检对话数（在当前筛选条件下，全部质检过的去重对话总数；汇总=100%）。">对话数占比</th>
              <th class="py-2 pr-4 col-mom col-delta" title="对话数占比环比">环比</th>
              <th class="py-2 pr-4 col-yoy col-delta" title="对话数占比同比">同比</th>
              <th class="py-2 pr-4 col-main col-group-start" title="标签命中数：按对话ID去重（每个对话只取最新一条AI质检分析）；同一对话命中多个标签会分别计入多个标签，因此上层汇总可能超过总对话数。">标签命中数</th>
              <th class="py-2 pr-4 col-mom col-delta" title="标签命中数环比">环比</th>
              <th class="py-2 pr-4 col-yoy col-delta" title="标签命中数同比">同比</th>
              <th class="py-2 pr-4 col-main col-group-start" title="标签占比 = 标签命中数 / 总质检对话数（在当前行维度+筛选条件下的总对话数）。此口径保持不变。">标签占比</th>
              <th class="py-2 pr-4 col-mom col-delta" title="标签占比环比">环比</th>
              <th class="py-2 pr-4 col-yoy col-delta" title="标签占比同比">同比</th>
            </tr>
          </thead>
          <tbody id="pivot-body"></tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<!-- Rule popup -->
<div id="rule-modal" class="fixed inset-0 hidden items-center justify-center bg-black/40 z-50">
  <div class="bg-white rounded-2xl p-4 w-full max-w-lg border">
    <div class="flex items-start justify-between gap-3">
      <div>
        <div id="rule-title" class="font-semibold"></div>
        <div class="text-xs text-slate-500 mt-1">这是给AI的命中标准（管理者可以在“标签管理”里修改）</div>
      </div>
      <button type="button" class="px-3 py-1.5 rounded-lg bg-white border text-sm" onclick="closeRule()">关闭</button>
    </div>
    <div id="rule-text" class="mt-3 text-sm whitespace-pre-wrap"></div>
  </div>
</div>

<!-- CID List popup -->
<div id="cid-list-modal" class="fixed inset-0 hidden items-center justify-center bg-black/40 z-50">
  <div class="bg-white rounded-2xl p-4 w-full max-w-2xl border max-h-[80vh] flex flex-col">
    <div class="flex items-start justify-between gap-3 mb-3">
      <div>
        <div id="cid-list-title" class="font-semibold">命中标签的对话列表</div>
        <div class="text-xs text-slate-500 mt-1">点击 CID 可查看对话详情</div>
      </div>
      <button type="button" class="px-3 py-1.5 rounded-lg bg-white border text-sm" onclick="closeCidList()">关闭</button>
    </div>
    <div id="cid-list-loading" class="text-sm text-slate-500">加载中...</div>
    <div id="cid-list-empty" class="text-sm text-slate-500 hidden">暂无数据</div>
    <div id="cid-list-content" class="overflow-x-auto overflow-y-auto flex-1 hidden">
      <table class="min-w-full text-sm">
        <thead class="sticky top-0 bg-white border-b">
          <tr class="text-left text-xs text-slate-500">
            <th class="py-2 pr-3 whitespace-nowrap">时间</th>
            <th class="py-2 pr-3 whitespace-nowrap">CID</th>
            <th class="py-2 pr-3 whitespace-nowrap">平台</th>
            <th class="py-2 pr-3 whitespace-nowrap">客服</th>
            <th class="py-2 pr-3 whitespace-nowrap">买家ID</th>
            <th class="py-2 pr-3 whitespace-nowrap">消息数</th>
            <th class="py-2 pr-3 whitespace-nowrap">场景</th>
            <th class="py-2 pr-3 whitespace-nowrap">满意度</th>
          </tr>
        </thead>
        <tbody id="cid-list-tbody" class="divide-y"></tbody>
      </table>
    </div>
    <div id="cid-list-pager" class="mt-3 flex items-center justify-between text-xs text-slate-500 hidden">
      <button id="cid-prev" type="button" class="px-2.5 py-1 rounded-lg border bg-white hover:bg-slate-50 disabled:opacity-40 disabled:cursor-not-allowed">上一页</button>
      <div id="cid-page-info" class="whitespace-nowrap"></div>
      <button id="cid-next" type="button" class="px-2.5 py-1 rounded-lg border bg-white hover:bg-slate-50 disabled:opacity-40 disabled:cursor-not-allowed">下一页</button>
    </div>
  </div>
</div>

<script>
	  const USER_ID = {{ user.id }};
	  const TAG_META = {{ tag_meta | tojson }};
	  const CATEGORY_META = {{ category_meta | tojson }};
	  const USER_META = {{ user_meta | tojson }};
	  const FORCE_TOUCH_DND = (new URLSearchParams(window.location.search).get("touch") === "1");
	  const IS_TOUCH_LIKE = FORCE_TOUCH_DND || (
	    (window.matchMedia && window.matchMedia('(pointer: coarse)').matches) ||
	    (navigator.maxTouchPoints && navigator.maxTouchPoints > 0)
	  );
  const IS_TOUCH_UI = IS_TOUCH_LIKE;
  const ENABLE_POINTER_DND = !!window.PointerEvent;

  const scenarioOrder = ["售前", "售后", "售前和售后", "其他接待场景", "无法判定", "未知"];
  const satisfactionOrder = ["大幅减少", "小幅减少", "无显著变化", "小幅增加", "大幅增加", "无法判定", "未知"];

  const FIELD_DEFS = [
    { id: "platform", label: "平台" },
    { id: "agent", label: "客服" },
    { id: "scenario", label: "接待场景" },
    { id: "satisfaction", label: "满意度变化" },
  ];
  const BASE_FIELDS = ["tag_category", "tag"];

  const DEFAULT_STATE = {
    time_mode: "{{ filters.time_mode }}",
    start: "{{ filters.start }}",
    end: "{{ filters.end }}",
    platform: "{{ filters.platform }}",
    agent_user_id: "{{ filters.agent_user_id }}",
    reception_scenario: "",
    satisfaction_change: "",
    show_mom: true,
    show_yoy: {{ "true" if filters.yoy else "false" }},
    row_fields: ["platform"],
    year: "",
    quarter: "1",
    month: "1",
    week: "1",
    day: "",
  };

  const stateKey = `tag_report_pivot_config_${USER_ID}`;
  let state = { ...DEFAULT_STATE };
  let pivotData = null;
  let refreshTimer = null;

  const tagById = new Map(TAG_META.map(t => [t.id, t]));
  const categoryById = new Map(CATEGORY_META.map(c => [c.id, c]));
  const userById = new Map(USER_META.map(u => [u.id, u]));

  const categoryOrderMap = new Map(
    CATEGORY_META
      .slice()
      .sort((a, b) => (a.sort_order - b.sort_order) || (a.id - b.id))
      .map((c, idx) => [String(c.id), idx])
  );

  const tagOrderMap = new Map(
    TAG_META
      .slice()
      .sort((a, b) => {
        const ac = categoryOrderMap.get(String(a.category_id)) ?? 9999;
        const bc = categoryOrderMap.get(String(b.category_id)) ?? 9999;
        if (ac !== bc) return ac - bc;
        if (a.sort_order !== b.sort_order) return a.sort_order - b.sort_order;
        return a.id - b.id;
      })
      .map((t, idx) => [String(t.id), idx])
  );

  function sanitizeRowFields(fields) {
    const allowed = new Set(FIELD_DEFS.map(f => f.id));
    const cleaned = Array.isArray(fields) ? fields.filter(f => allowed.has(f)) : [];
    return cleaned.length ? cleaned : DEFAULT_STATE.row_fields.slice();
  }

  function loadState() {
    try {
      const raw = localStorage.getItem(stateKey);
      if (!raw) return;
      const saved = JSON.parse(raw);
      if (saved && typeof saved === "object") {
        state = { ...state, ...saved };
        state.row_fields = sanitizeRowFields(state.row_fields);
      }
    } catch (e) {}
  }

  function saveState() {
    try {
      localStorage.setItem(stateKey, JSON.stringify(state));
    } catch (e) {}
  }

  function setState(next) {
    state = { ...state, ...next };
    state.row_fields = sanitizeRowFields(state.row_fields);
    saveState();
  }

  function getISOWeek(date) {
    const d = new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()));
    const dayNum = d.getUTCDay() || 7;
    d.setUTCDate(d.getUTCDate() + 4 - dayNum);
    const yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
    return Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
  }

  function getISOWeeksInYear(year) {
    return getISOWeek(new Date(Date.UTC(year, 11, 28)));
  }

  function isoWeekToDate(year, week) {
    const simple = new Date(Date.UTC(year, 0, 1 + (week - 1) * 7));
    const dow = simple.getUTCDay() || 7;
    if (dow <= 4) {
      simple.setUTCDate(simple.getUTCDate() - dow + 1);
    } else {
      simple.setUTCDate(simple.getUTCDate() + 8 - dow);
    }
    return new Date(simple.getUTCFullYear(), simple.getUTCMonth(), simple.getUTCDate());
  }

  function initTimeSelectors() {
    const yearSelect = document.getElementById("year-select");
    const quarterSelect = document.getElementById("quarter-select");
    const monthSelect = document.getElementById("month-select");
    const weekSelect = document.getElementById("week-select");

    const now = new Date();
    const currentYear = now.getFullYear();
    const startYear = currentYear - 10;
    const endYear = currentYear + 1;

    yearSelect.innerHTML = "";
    for (let y = endYear; y >= startYear; y -= 1) {
      const opt = document.createElement("option");
      opt.value = String(y);
      opt.textContent = `${y} 年`;
      yearSelect.appendChild(opt);
    }

    quarterSelect.innerHTML = "";
    for (let q = 1; q <= 4; q += 1) {
      const opt = document.createElement("option");
      opt.value = String(q);
      opt.textContent = `Q${q}`;
      quarterSelect.appendChild(opt);
    }

    monthSelect.innerHTML = "";
    for (let m = 1; m <= 12; m += 1) {
      const opt = document.createElement("option");
      opt.value = String(m);
      opt.textContent = `${m} 月`;
      monthSelect.appendChild(opt);
    }

    updateWeekOptions();
  }

  function updateWeekOptions() {
    const yearSelect = document.getElementById("year-select");
    const weekSelect = document.getElementById("week-select");
    const year = Number(yearSelect.value || new Date().getFullYear());
    const totalWeeks = getISOWeeksInYear(year);
    const currentWeek = state.week || "";
    weekSelect.innerHTML = "";
    for (let w = 1; w <= totalWeeks; w += 1) {
      const opt = document.createElement("option");
      opt.value = String(w);
      opt.textContent = `第 ${w} 周`;
      weekSelect.appendChild(opt);
    }
    if (currentWeek) {
      weekSelect.value = currentWeek;
    }
  }

  function syncTimeSelectorsFromState() {
    const now = new Date();
    const startDate = state.start ? new Date(state.start) : now;
    const year = state.year || String(startDate.getFullYear());
    const quarter = state.quarter || String(Math.floor(startDate.getMonth() / 3) + 1);
    const month = state.month || String(startDate.getMonth() + 1);
    const week = state.week || String(getISOWeek(startDate));
    const day = state.day || (state.start || "");

    const yearSelect = document.getElementById("year-select");
    if (!Array.from(yearSelect.options).some(opt => opt.value === year)) {
      const opt = document.createElement("option");
      opt.value = year;
      opt.textContent = `${year} 年`;
      yearSelect.appendChild(opt);
    }
    yearSelect.value = year;
    updateWeekOptions();
    document.getElementById("quarter-select").value = quarter;
    document.getElementById("month-select").value = month;
    document.getElementById("week-select").value = week;
    document.getElementById("day-select").value = day;

    setState({ year, quarter, month, week, day });
  }

  function getLastFullPeriodSelection(mode) {
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    const yesterday = new Date(today);
    yesterday.setDate(today.getDate() - 1);

    if (mode === "yesterday") {
      return {
        year: String(yesterday.getFullYear()),
        quarter: String(Math.floor(yesterday.getMonth() / 3) + 1),
        month: String(yesterday.getMonth() + 1),
        week: String(getISOWeek(yesterday)),
        day: yesterday.toISOString().slice(0, 10),
      };
    }

    if (mode === "last_week") {
      const dayOfWeek = today.getDay() || 7;
      const thisMonday = new Date(today);
      thisMonday.setDate(today.getDate() - (dayOfWeek - 1));
      const lastMonday = new Date(thisMonday);
      lastMonday.setDate(thisMonday.getDate() - 7);
      return {
        year: String(lastMonday.getFullYear()),
        week: String(getISOWeek(lastMonday)),
        quarter: String(Math.floor(lastMonday.getMonth() / 3) + 1),
        month: String(lastMonday.getMonth() + 1),
        day: "",
      };
    }

    if (mode === "last_month") {
      let year = today.getFullYear();
      let month = today.getMonth();
      if (month === 0) {
        month = 12;
        year -= 1;
      }
      return {
        year: String(year),
        month: String(month),
        quarter: String(Math.floor((month - 1) / 3) + 1),
        week: "",
        day: "",
      };
    }

    if (mode === "last_quarter") {
      const currentQuarter = Math.floor(today.getMonth() / 3) + 1;
      let quarter = currentQuarter - 1;
      let year = today.getFullYear();
      if (quarter <= 0) {
        quarter = 4;
        year -= 1;
      }
      const month = (quarter - 1) * 3 + 1;
      return {
        year: String(year),
        quarter: String(quarter),
        month: String(month),
        week: "",
        day: "",
      };
    }

    if (mode === "last_year") {
      const year = today.getFullYear() - 1;
      return {
        year: String(year),
        quarter: "1",
        month: "1",
        week: "",
        day: "",
      };
    }

    return null;
  }

  function ensureDefaultTimeForMode(mode, force) {
    if (!force && state.time_initialized) return;
    if (mode === "all" || mode === "custom") {
      setState({ time_initialized: true });
      return;
    }
    const selection = getLastFullPeriodSelection(mode);
    if (!selection) return;
    setState({ ...selection, time_initialized: true });
    syncTimeSelectorsFromState();
  }

  function applyStateToFilters() {
    document.getElementById("time-mode").value = state.time_mode || DEFAULT_STATE.time_mode;
    document.getElementById("start-date").value = state.start || "";
    document.getElementById("end-date").value = state.end || "";
    document.getElementById("platform-filter").value = state.platform || "";
    document.getElementById("agent-filter").value = state.agent_user_id || "";
    document.getElementById("scenario-filter").value = state.reception_scenario || "";
    document.getElementById("satisfaction-filter").value = state.satisfaction_change || "";
    initTimeSelectors();
    ensureDefaultTimeForMode(document.getElementById("time-mode").value, false);
    syncTimeSelectorsFromState();
    updateToggleButtons();
    applyTimeModeUI();
  }

  function applyTimeModeUI() {
    const mode = document.getElementById("time-mode").value;
    const yearWrap = document.getElementById("year-wrap");
    const quarterWrap = document.getElementById("quarter-wrap");
    const monthWrap = document.getElementById("month-wrap");
    const weekWrap = document.getElementById("week-wrap");
    const dayWrap = document.getElementById("day-wrap");
    const customStartWrap = document.getElementById("custom-start-wrap");
    const customEndWrap = document.getElementById("custom-end-wrap");

    const hideAll = () => {
      yearWrap.classList.add("hidden");
      quarterWrap.classList.add("hidden");
      monthWrap.classList.add("hidden");
      weekWrap.classList.add("hidden");
      dayWrap.classList.add("hidden");
      customStartWrap.classList.add("hidden");
      customEndWrap.classList.add("hidden");
    };

    hideAll();

    if (mode === "custom") {
      customStartWrap.classList.remove("hidden");
      customEndWrap.classList.remove("hidden");
    } else if (mode === "all") {
      // No date selectors
    } else if (mode === "last_year") {
      yearWrap.classList.remove("hidden");
    } else if (mode === "last_quarter") {
      yearWrap.classList.remove("hidden");
      quarterWrap.classList.remove("hidden");
    } else if (mode === "last_month") {
      yearWrap.classList.remove("hidden");
      monthWrap.classList.remove("hidden");
    } else if (mode === "last_week") {
      yearWrap.classList.remove("hidden");
      weekWrap.classList.remove("hidden");
    } else {
      dayWrap.classList.remove("hidden");
    }
  }

  function updateToggleButtons() {
    const momBtn = document.getElementById("toggle-mom");
    const yoyBtn = document.getElementById("toggle-yoy");
    momBtn.className = state.show_mom ? "px-2.5 py-1 rounded-lg bg-slate-900 text-white text-xs" : "px-2.5 py-1 rounded-lg border text-xs";
    yoyBtn.className = state.show_yoy ? "px-2.5 py-1 rounded-lg bg-slate-900 text-white text-xs" : "px-2.5 py-1 rounded-lg border text-xs";
    updateColumnVisibility();
  }

  function updateColumnVisibility() {
    document.querySelectorAll(".col-mom").forEach(el => {
      if (state.show_mom) {
        el.classList.remove("hidden");
      } else {
        el.classList.add("hidden");
      }
    });
    document.querySelectorAll(".col-yoy").forEach(el => {
      if (state.show_yoy) {
        el.classList.remove("hidden");
      } else {
        el.classList.add("hidden");
      }
    });
  }

  function scheduleRefresh() {
    if (refreshTimer) clearTimeout(refreshTimer);
    refreshTimer = setTimeout(refreshReport, 150);
  }

  async function refreshReport() {
    document.getElementById("pivot-loading").classList.remove("hidden");
    document.getElementById("pivot-empty").classList.add("hidden");

    const params = new URLSearchParams();
    params.append("time_mode", document.getElementById("time-mode").value);
    const mode = document.getElementById("time-mode").value;

    if (mode === "custom") {
      const start = document.getElementById("start-date").value;
      const end = document.getElementById("end-date").value;
      if (start) params.append("start", start);
      if (end) params.append("end", end);
      setState({ start, end });
    } else if (mode !== "all") {
      let anchor = "";
      if (mode === "last_year") {
        const year = document.getElementById("year-select").value;
        anchor = `${year}-01-01`;
        setState({ year });
      } else if (mode === "last_quarter") {
        const year = document.getElementById("year-select").value;
        const quarter = document.getElementById("quarter-select").value;
        const month = (Number(quarter) - 1) * 3 + 1;
        anchor = `${year}-${String(month).padStart(2, "0")}-01`;
        setState({ year, quarter });
      } else if (mode === "last_month") {
        const year = document.getElementById("year-select").value;
        const month = document.getElementById("month-select").value;
        anchor = `${year}-${String(month).padStart(2, "0")}-01`;
        setState({ year, month });
      } else if (mode === "last_week") {
        const year = document.getElementById("year-select").value;
        const week = document.getElementById("week-select").value;
        const anchorDate = isoWeekToDate(Number(year), Number(week));
        anchor = anchorDate.toISOString().slice(0, 10);
        setState({ year, week });
      } else {
        const day = document.getElementById("day-select").value;
        anchor = day;
        setState({ day });
      }

      if (anchor) {
        params.append("start", anchor);
        params.append("end", anchor);
        setState({ start: anchor, end: anchor });
      }
    }

    const platform = document.getElementById("platform-filter").value;
    const agentUserId = document.getElementById("agent-filter").value;
    const scenario = document.getElementById("scenario-filter").value;
    const satisfaction = document.getElementById("satisfaction-filter").value;

    if (platform) params.append("platform", platform);
    if (agentUserId) params.append("agent_user_id", agentUserId);
    if (scenario) params.append("reception_scenario", scenario);
    if (satisfaction) params.append("satisfaction_change", satisfaction);

    if (state.show_yoy) {
      params.append("yoy", "1");
    }

    setState({
      time_mode: mode,
      platform: platform,
      agent_user_id: agentUserId,
      reception_scenario: scenario,
      satisfaction_change: satisfaction,
    });

    try {
      const resp = await fetch(`/api/reports/tags/pivot-data?${params.toString()}`);
      const data = await resp.json();
      pivotData = data;

      if (data.range) {
        const startInput = document.getElementById("start-date");
        const endInput = document.getElementById("end-date");
        startInput.value = data.range.current_start || "";
        endInput.value = data.range.current_end || "";
        setState({ start: startInput.value, end: endInput.value });
      }

      renderPeriodLabel();
      renderPivot();
    } catch (e) {
      document.getElementById("pivot-empty").textContent = `加载失败：${e.message}`;
      document.getElementById("pivot-empty").classList.remove("hidden");
      document.getElementById("pivot-loading").classList.add("hidden");
    }
  }

  function renderPeriodLabel() {
    const label = document.getElementById("period-label");
    if (!pivotData || !pivotData.period) {
      label.textContent = "";
      return;
    }
    const cur = pivotData.period.current_label || "";
    const prev = pivotData.period.prev_label || "";
    const yoy = pivotData.period.yoy_label || "";
    const parts = [];
    if (cur) parts.push(`当前周期：${cur}`);
    if (prev) parts.push(`环比：${prev}`);
    if (yoy) parts.push(`同比：${yoy}`);
    label.textContent = parts.join(" ｜ ");
  }

  function getFieldValue(record, field) {
    if (field === "tag_category") return record.category_id || 0;
    if (field === "tag") return record.tag_id || 0;
    if (field === "platform") return record.platform || "";
    if (field === "agent") return record.agent_user_id || 0;
    if (field === "scenario") return record.reception_scenario || "";
    if (field === "satisfaction") return record.satisfaction_change || "";
    return "";
  }

  function formatLabel(field, value) {
    if (field === "tag_category") {
      const cat = categoryById.get(Number(value));
      return cat ? cat.name : "未分类";
    }
    if (field === "tag") {
      const tag = tagById.get(Number(value));
      return tag ? tag.name : "未命名标签";
    }
    if (field === "platform") {
      return value || "未知平台";
    }
    if (field === "agent") {
      if (!value || Number(value) === 0) return "未绑定客服";
      const user = userById.get(Number(value));
      return user ? user.name : `UID:${value}`;
    }
    if (field === "scenario") {
      return value || "未知";
    }
    if (field === "satisfaction") {
      return value || "未知";
    }
    return String(value || "");
  }

  function getSortKey(field, value) {
    if (field === "tag_category") {
      return categoryOrderMap.get(String(value)) ?? 9999;
    }
    if (field === "tag") {
      return tagOrderMap.get(String(value)) ?? 9999;
    }
    if (field === "scenario") {
      const idx = scenarioOrder.indexOf(value || "未知");
      return idx === -1 ? 9999 : idx;
    }
    if (field === "satisfaction") {
      const idx = satisfactionOrder.indexOf(value || "未知");
      return idx === -1 ? 9999 : idx;
    }
    if (field === "agent") {
      const user = userById.get(Number(value));
      return user ? user.name : String(value || "");
    }
    return String(value || "");
  }

  function buildTotalIndex(totals) {
    const idx = new Map();
    totals.forEach(t => {
      const key = `${t.platform || ""}||${t.agent_user_id || 0}||${t.reception_scenario || ""}||${t.satisfaction_change || ""}`;
      idx.set(key, t);
    });
    return idx;
  }

  function buildTaggedTotalIndex(taggedTotals) {
    const idx = new Map();
    taggedTotals.forEach(t => {
      const key = `${t.platform || ""}||${t.agent_user_id || 0}||${t.reception_scenario || ""}||${t.satisfaction_change || ""}`;
      idx.set(key, t);
    });
    return idx;
  }

  function buildTaggedCategoryIndex(taggedCategoryTotals) {
    const idx = new Map();
    taggedCategoryTotals.forEach(t => {
      const key = `${t.category_id || 0}||${t.platform || ""}||${t.agent_user_id || 0}||${t.reception_scenario || ""}||${t.satisfaction_change || ""}`;
      idx.set(key, t);
    });
    return idx;
  }

  function getTotalsForDims(totalIndex, dims) {
    const key = JSON.stringify({
      platform: dims.platform || "",
      agent: dims.agent_user_id || 0,
      scenario: dims.reception_scenario || "",
      satisfaction: dims.satisfaction_change || "",
    });
    if (!getTotalsForDims.cache) {
      getTotalsForDims.cache = new Map();
    }
    if (getTotalsForDims.cache.has(key)) {
      return getTotalsForDims.cache.get(key);
    }

    let cur = 0;
    let prev = 0;
    let yoy = 0;

    for (const [k, v] of totalIndex.entries()) {
      const [plat, agent, scenario, satisfaction] = k.split("||");
      if (dims.platform && plat !== String(dims.platform)) continue;
      if (dims.agent_user_id && String(agent) !== String(dims.agent_user_id)) continue;
      if (dims.reception_scenario && scenario !== String(dims.reception_scenario)) continue;
      if (dims.satisfaction_change && satisfaction !== String(dims.satisfaction_change)) continue;
      cur += v.current || 0;
      prev += v.prev || 0;
      yoy += v.yoy || 0;
    }

    const result = { current: cur, prev, yoy };
    getTotalsForDims.cache.set(key, result);
    return result;
  }

  function getTaggedTotalsForDims(taggedIndex, dims) {
    const key = JSON.stringify({
      platform: dims.platform || "",
      agent: dims.agent_user_id || 0,
      scenario: dims.reception_scenario || "",
      satisfaction: dims.satisfaction_change || "",
    });
    if (!getTaggedTotalsForDims.cache) {
      getTaggedTotalsForDims.cache = new Map();
    }
    if (getTaggedTotalsForDims.cache.has(key)) {
      return getTaggedTotalsForDims.cache.get(key);
    }

    let cur = 0;
    let prev = 0;
    let yoy = 0;
    for (const [k, v] of taggedIndex.entries()) {
      const [plat, agent, scenario, satisfaction] = k.split("||");
      if (dims.platform && plat !== String(dims.platform)) continue;
      if (dims.agent_user_id && String(agent) !== String(dims.agent_user_id)) continue;
      if (dims.reception_scenario && scenario !== String(dims.reception_scenario)) continue;
      if (dims.satisfaction_change && satisfaction !== String(dims.satisfaction_change)) continue;
      cur += v.current || 0;
      prev += v.prev || 0;
      yoy += v.yoy || 0;
    }

    const result = { current: cur, prev, yoy };
    getTaggedTotalsForDims.cache.set(key, result);
    return result;
  }

  function getTaggedCategoryTotalsForDims(taggedCategoryIndex, dims) {
    const key = JSON.stringify({
      category_id: dims.category_id || 0,
      platform: dims.platform || "",
      agent: dims.agent_user_id || 0,
      scenario: dims.reception_scenario || "",
      satisfaction: dims.satisfaction_change || "",
    });
    if (!getTaggedCategoryTotalsForDims.cache) {
      getTaggedCategoryTotalsForDims.cache = new Map();
    }
    if (getTaggedCategoryTotalsForDims.cache.has(key)) {
      return getTaggedCategoryTotalsForDims.cache.get(key);
    }

    let cur = 0;
    let prev = 0;
    let yoy = 0;
    for (const [k, v] of taggedCategoryIndex.entries()) {
      const [catId, plat, agent, scenario, satisfaction] = k.split("||");
      if (String(catId) !== String(dims.category_id || 0)) continue;
      if (dims.platform && plat !== String(dims.platform)) continue;
      if (dims.agent_user_id && String(agent) !== String(dims.agent_user_id)) continue;
      if (dims.reception_scenario && scenario !== String(dims.reception_scenario)) continue;
      if (dims.satisfaction_change && satisfaction !== String(dims.satisfaction_change)) continue;
      cur += v.current || 0;
      prev += v.prev || 0;
      yoy += v.yoy || 0;
    }

    const result = { current: cur, prev, yoy };
    getTaggedCategoryTotalsForDims.cache.set(key, result);
    return result;
  }

  function formatDelta(cur, base) {
    if (!base || base <= 0) {
      return cur <= 0 ? "—" : `+${cur}`;
    }
    const diff = cur - base;
    const pct = (diff / base) * 100;
    const sign = diff >= 0 ? "+" : "";
    return `${sign}${diff} (${sign}${pct.toFixed(0)}%)`;
  }

  function formatDeltaCompact(cur, base) {
    if (!base || base <= 0) {
      return cur <= 0 ? "—" : `+${cur}`;
    }
    const diff = cur - base;
    const pct = (diff / base) * 100;
    const sign = diff >= 0 ? "+" : "";
    return `${sign}${pct.toFixed(0)}%`;
  }

  function formatRatio(value) {
    if (value === null || value === undefined || isNaN(value)) return "—";
    return `${value.toFixed(2)}%`;
  }

  function formatRatioDelta(cur, base) {
    if (base === null || base === undefined || base <= 0 || isNaN(base)) {
      return cur <= 0 ? "—" : `+${cur.toFixed(2)}pp`;
    }
    const diff = cur - base;
    const pct = (diff / base) * 100;
    const sign = diff >= 0 ? "+" : "";
    return `${sign}${diff.toFixed(2)}pp (${sign}${pct.toFixed(0)}%)`;
  }

  function formatRatioDeltaCompact(cur, base) {
    if (base === null || base === undefined || base <= 0 || isNaN(base)) {
      return cur <= 0 ? "—" : `+${cur.toFixed(2)}pp`;
    }
    const diff = cur - base;
    const sign = diff >= 0 ? "+" : "";
    return `${sign}${diff.toFixed(2)}pp`;
  }

  function getEffectiveRowFields() {
    const selected = sanitizeRowFields(state.row_fields);
    BASE_FIELDS.forEach(f => {
      if (!selected.includes(f)) selected.push(f);
    });
    return selected;
  }

  function buildTree(records, rowFields) {
    let gid = 1;
    const root = {
      id: "root",
      label: "汇总",
      field: "root",
      value: "root",
      level: 0,
      dims: {},
      tag_id: null,
      metrics: { current: 0, prev: 0, yoy: 0 },
      children: new Map(),
    };

    records.forEach(rec => {
      root.metrics.current += rec.current || 0;
      root.metrics.prev += rec.prev || 0;
      root.metrics.yoy += rec.yoy || 0;
      let node = root;

      rowFields.forEach((field, idx) => {
        const value = getFieldValue(rec, field);
        const key = `${field}::${value}`;
        if (!node.children.has(key)) {
          const newNode = {
            id: `g${gid++}`,
            label: formatLabel(field, value),
            field,
            value,
            level: idx + 1,
            dims: { ...node.dims },
            tag_id: null,
            metrics: { current: 0, prev: 0, yoy: 0 },
            children: new Map(),
          };
          if (field === "platform") newNode.dims.platform = value || "";
          if (field === "agent") newNode.dims.agent_user_id = value || 0;
          if (field === "scenario") newNode.dims.reception_scenario = value || "";
          if (field === "satisfaction") newNode.dims.satisfaction_change = value || "";
          if (field === "tag_category") newNode.dims.category_id = value || 0;
          if (field === "tag") {
            newNode.dims.tag_id = value || 0;
            newNode.tag_id = value || 0;
          }
          node.children.set(key, newNode);
        }
        node = node.children.get(key);
        node.metrics.current += rec.current || 0;
        node.metrics.prev += rec.prev || 0;
        node.metrics.yoy += rec.yoy || 0;
      });
    });

    return root;
  }

  function flattenTree(node, rows, parentId = "") {
    rows.push({
      id: node.id,
      parent_id: parentId,
      level: node.level,
      label: node.label,
      field: node.field,
      value: node.value,
      is_header: node.children.size > 0,
      metrics: node.metrics,
      dims: node.dims,
      tag_id: node.tag_id,
    });

    const children = Array.from(node.children.values());
    if (children.length === 0) return;
    const field = children[0].field;
    children.sort((a, b) => {
      const ak = getSortKey(field, a.value);
      const bk = getSortKey(field, b.value);
      if (typeof ak === "string" || typeof bk === "string") {
        return String(ak).localeCompare(String(bk), "zh-Hans-CN");
      }
      return ak - bk;
    });

    children.forEach(child => flattenTree(child, rows, node.id));
  }

  function renderPivot() {
    const tbody = document.getElementById("pivot-body");
    tbody.innerHTML = "";
    document.getElementById("pivot-loading").classList.add("hidden");
    const hasTagHits = pivotData && Array.isArray(pivotData.tag_hits) && pivotData.tag_hits.length > 0;
    const hasTotals = pivotData && Array.isArray(pivotData.totals) && pivotData.totals.length > 0;
    if (!pivotData || (!hasTagHits && !hasTotals)) {
      document.getElementById("pivot-empty").classList.remove("hidden");
      return;
    }

    getTotalsForDims.cache = new Map();
    getTaggedCategoryTotalsForDims.cache = new Map();
    const totalIndex = buildTotalIndex(pivotData.totals || []);
    const taggedCategoryIndex = buildTaggedCategoryIndex(pivotData.tagged_category_totals || []);
    const root = buildTree(pivotData.tag_hits || [], getEffectiveRowFields());

    const rows = [];
    flattenTree(root, rows);
    const qcGrandTotals = getTotalsForDims(totalIndex, {});

    rows.forEach(r => {
      const totals = getTotalsForDims(totalIndex, r.dims || {});
      const ratioCur = totals.current > 0 ? (r.metrics.current / totals.current) * 100 : 0;
      const ratioPrev = totals.prev > 0 ? (r.metrics.prev / totals.prev) * 100 : 0;
      const ratioYoy = totals.yoy > 0 ? (r.metrics.yoy / totals.yoy) * 100 : 0;

      let qcCur = 0;
      let qcPrev = 0;
      let qcYoy = 0;
      if (r.field === "tag") {
        qcCur = r.metrics.current || 0;
        qcPrev = r.metrics.prev || 0;
        qcYoy = r.metrics.yoy || 0;
      } else if (r.field === "tag_category") {
        const x = getTaggedCategoryTotalsForDims(taggedCategoryIndex, r.dims || {});
        qcCur = x.current || 0;
        qcPrev = x.prev || 0;
        qcYoy = x.yoy || 0;
      } else {
        const x = getTotalsForDims(totalIndex, r.dims || {});
        qcCur = x.current || 0;
        qcPrev = x.prev || 0;
        qcYoy = x.yoy || 0;
      }
      const qcShareCur = qcGrandTotals.current > 0 ? (qcCur / qcGrandTotals.current) * 100 : null;
      const qcSharePrev = qcGrandTotals.prev > 0 ? (qcPrev / qcGrandTotals.prev) * 100 : null;
      const qcShareYoy = qcGrandTotals.yoy > 0 ? (qcYoy / qcGrandTotals.yoy) * 100 : null;

      const tr = document.createElement("tr");
      tr.className = `border-b ${r.is_header ? "bg-slate-50 font-medium" : ""}`;
      tr.dataset.rowId = `${r.id}-${r.is_header ? "header" : "row"}`;
      tr.dataset.level = r.level;
      tr.dataset.parent = r.parent_id || "";
      tr.dataset.group = r.id;
      tr.dataset.isHeader = r.is_header ? "True" : "False";

      const nameTd = document.createElement("td");
      nameTd.className = "py-2 pr-4 dim-col";
      nameTd.title = r.label || "";

      if (r.is_header) {
        const btn = document.createElement("button");
        btn.type = "button";
        btn.className = "text-left w-full truncate";
        btn.style.paddingLeft = `${r.level * 20}px`;
        const ico = document.createElement("span");
        ico.id = `ico-${r.id}`;
        ico.textContent = "▾";
        btn.appendChild(ico);
        btn.appendChild(document.createTextNode(" "));
        btn.addEventListener("click", () => toggleGroup(r.id));
        if (r.field === "tag") {
          const tag = tagById.get(Number(r.value));
          if (tag) {
            const tagLink = document.createElement("span");
            tagLink.className = "underline";
            tagLink.dataset.ruleTitle = tag.name || r.label;
            tagLink.dataset.ruleText = tag.standard || "未配置";
            tagLink.textContent = r.label;
            tagLink.addEventListener("click", (e) => {
              e.stopPropagation();
              showRule(tagLink);
            });
            btn.appendChild(tagLink);
          } else {
            btn.appendChild(document.createTextNode(r.label));
          }
        } else {
          btn.appendChild(document.createTextNode(r.label));
        }
        nameTd.appendChild(btn);
      } else {
        const inner = document.createElement("div");
        inner.style.paddingLeft = `${r.level * 20 + 20}px`;
        if (r.field === "tag") {
          const tag = tagById.get(Number(r.value));
          if (tag) {
            const tagBtn = document.createElement("button");
            tagBtn.type = "button";
            tagBtn.className = "underline";
            tagBtn.dataset.ruleTitle = tag.name || r.label;
            tagBtn.dataset.ruleText = tag.standard || "未配置";
            tagBtn.textContent = r.label;
            tagBtn.addEventListener("click", () => showRule(tagBtn));
            inner.appendChild(tagBtn);
          } else {
            inner.textContent = r.label;
          }
        } else {
          inner.textContent = r.label;
        }
        nameTd.appendChild(inner);
      }

      const qcTd = document.createElement("td");
      qcTd.className = "py-2 pr-4 col-main col-group-start";
      const qcCanClick = qcCur > 0;
      if (qcCanClick) {
        const btn = document.createElement("button");
        btn.type = "button";
        btn.className = "underline text-blue-600 hover:text-blue-800";
        btn.textContent = qcCur;
        if (r.tag_id) btn.dataset.tagId = r.tag_id;
        if (r.dims && r.dims.category_id) btn.dataset.categoryId = r.dims.category_id;
        btn.dataset.platform = (r.dims && r.dims.platform) ? r.dims.platform : "";
        btn.dataset.agentUserId = (r.dims && r.dims.agent_user_id) ? r.dims.agent_user_id : "";
        btn.dataset.scenario = (r.dims && r.dims.reception_scenario) ? r.dims.reception_scenario : "";
        btn.dataset.satisfaction = (r.dims && r.dims.satisfaction_change) ? r.dims.satisfaction_change : "";
        btn.addEventListener("click", () => showQcCids(btn));
        qcTd.appendChild(btn);
      } else {
        qcTd.textContent = qcCur;
      }

      const qcMomTd = document.createElement("td");
      qcMomTd.className = "py-2 pr-4 col-mom col-delta";
      if (pivotData.period && pivotData.period.prev_label) {
        qcMomTd.textContent = formatDeltaCompact(qcCur, qcPrev);
        qcMomTd.title = formatDelta(qcCur, qcPrev);
      } else {
        qcMomTd.textContent = "—";
      }

      const qcYoyTd = document.createElement("td");
      qcYoyTd.className = "py-2 pr-4 col-yoy col-delta";
      if (pivotData.period && pivotData.period.yoy_label) {
        qcYoyTd.textContent = formatDeltaCompact(qcCur, qcYoy);
        qcYoyTd.title = formatDelta(qcCur, qcYoy);
      } else {
        qcYoyTd.textContent = "—";
      }

      const qcShareTd = document.createElement("td");
      qcShareTd.className = "py-2 pr-4 col-main col-group-start";
      qcShareTd.textContent = formatRatio(qcShareCur);

      const qcShareMomTd = document.createElement("td");
      qcShareMomTd.className = "py-2 pr-4 col-mom col-delta";
      if (pivotData.period && pivotData.period.prev_label && qcShareCur !== null && qcSharePrev !== null) {
        qcShareMomTd.textContent = formatRatioDeltaCompact(qcShareCur, qcSharePrev);
        qcShareMomTd.title = formatRatioDelta(qcShareCur, qcSharePrev);
      } else {
        qcShareMomTd.textContent = "—";
      }

      const qcShareYoyTd = document.createElement("td");
      qcShareYoyTd.className = "py-2 pr-4 col-yoy col-delta";
      if (pivotData.period && pivotData.period.yoy_label && qcShareCur !== null && qcShareYoy !== null) {
        qcShareYoyTd.textContent = formatRatioDeltaCompact(qcShareCur, qcShareYoy);
        qcShareYoyTd.title = formatRatioDelta(qcShareCur, qcShareYoy);
      } else {
        qcShareYoyTd.textContent = "—";
      }

      const countTd = document.createElement("td");
      countTd.className = "py-2 pr-4 col-main col-group-start";
      const canClick = r.tag_id && r.metrics.current > 0;
      if (canClick) {
        const btn = document.createElement("button");
        btn.type = "button";
        btn.className = "underline text-blue-600 hover:text-blue-800";
        btn.textContent = r.metrics.current;
        btn.dataset.tagId = r.tag_id;
        btn.dataset.platform = r.dims.platform || "";
        btn.dataset.agentUserId = r.dims.agent_user_id || "";
        btn.dataset.scenario = r.dims.reception_scenario || "";
        btn.dataset.satisfaction = r.dims.satisfaction_change || "";
        btn.addEventListener("click", () => showTagCids(btn));
        countTd.appendChild(btn);
      } else {
        countTd.textContent = r.metrics.current;
      }

      const momTd = document.createElement("td");
      momTd.className = "py-2 pr-4 col-mom col-delta";
      if (pivotData.period && pivotData.period.prev_label) {
        momTd.textContent = formatDeltaCompact(r.metrics.current, r.metrics.prev);
        momTd.title = formatDelta(r.metrics.current, r.metrics.prev);
      } else {
        momTd.textContent = "—";
      }

      const yoyTd = document.createElement("td");
      yoyTd.className = "py-2 pr-4 col-yoy col-delta";
      if (pivotData.period && pivotData.period.yoy_label) {
        yoyTd.textContent = formatDeltaCompact(r.metrics.current, r.metrics.yoy);
        yoyTd.title = formatDelta(r.metrics.current, r.metrics.yoy);
      } else {
        yoyTd.textContent = "—";
      }

      const ratioTd = document.createElement("td");
      ratioTd.className = "py-2 pr-4 col-main col-group-start";
      ratioTd.textContent = formatRatio(totals.current > 0 ? ratioCur : null);

      const ratioMomTd = document.createElement("td");
      ratioMomTd.className = "py-2 pr-4 col-mom col-delta";
      if (pivotData.period && pivotData.period.prev_label) {
        ratioMomTd.textContent = formatRatioDeltaCompact(ratioCur, ratioPrev);
        ratioMomTd.title = formatRatioDelta(ratioCur, ratioPrev);
      } else {
        ratioMomTd.textContent = "—";
      }

      const ratioYoyTd = document.createElement("td");
      ratioYoyTd.className = "py-2 pr-4 col-yoy col-delta";
      if (pivotData.period && pivotData.period.yoy_label) {
        ratioYoyTd.textContent = formatRatioDeltaCompact(ratioCur, ratioYoy);
        ratioYoyTd.title = formatRatioDelta(ratioCur, ratioYoy);
      } else {
        ratioYoyTd.textContent = "—";
      }

      tr.appendChild(nameTd);
      tr.appendChild(qcTd);
      tr.appendChild(qcMomTd);
      tr.appendChild(qcYoyTd);
      tr.appendChild(qcShareTd);
      tr.appendChild(qcShareMomTd);
      tr.appendChild(qcShareYoyTd);
      tr.appendChild(countTd);
      tr.appendChild(momTd);
      tr.appendChild(yoyTd);
      tr.appendChild(ratioTd);
      tr.appendChild(ratioMomTd);
      tr.appendChild(ratioYoyTd);

      tbody.appendChild(tr);
    });

    updateColumnVisibility();
    populateLevelSelect();
  }

  function populateLevelSelect() {
    const select = document.getElementById("level-select");
    const hint = document.getElementById("level-hint");
    const expandBtn = document.getElementById("expand-level");
    const collapseBtn = document.getElementById("collapse-level");
    const prevValue = select.value;
    select.innerHTML = "";
    const fields = getEffectiveRowFields();
    const levels = fields.map((field, idx) => {
      const def = FIELD_DEFS.find(f => f.id === field);
      if (def) return { level: idx + 1, label: def.label };
      if (field === "tag_category") return { level: idx + 1, label: "标签一级分类" };
      if (field === "tag") return { level: idx + 1, label: "标签" };
      return { level: idx + 1, label: field };
    });
    if (levels.length === 0) {
      const opt = document.createElement("option");
      opt.value = "1";
      opt.textContent = "先选择行维度";
      select.appendChild(opt);
      select.disabled = true;
      if (expandBtn) expandBtn.disabled = true;
      if (collapseBtn) collapseBtn.disabled = true;
      if (hint) hint.textContent = "先在下方「已选维度（行）」里拖入至少 1 个维度，再按层级展开/收起。";
      return;
    }
    select.disabled = false;
    if (expandBtn) expandBtn.disabled = false;
    if (collapseBtn) collapseBtn.disabled = false;
    if (hint) hint.textContent = "";
    levels.forEach(l => {
      const opt = document.createElement("option");
      opt.value = l.level;
      opt.textContent = `第${l.level}层：${l.label}`;
      select.appendChild(opt);
    });

    // 保留用户之前选中的层级（如果仍然存在）
    const maxLevel = levels.length;
    const v = Number(prevValue || 1);
    const nextValue = String(Math.min(Math.max(v, 1), maxLevel));
    select.value = nextValue;
  }

  function toggleGroup(groupId) {
    const ico = document.getElementById("ico-" + groupId);
    const isExpanded = ico && ico.textContent === "▾";

    if (isExpanded) {
      hideAllDescendants(groupId);
      if (ico) ico.textContent = "▸";
    } else {
      const directChildren = document.querySelectorAll('[data-parent="' + groupId + '"]');
      directChildren.forEach(child => child.classList.remove("hidden"));
      if (ico) ico.textContent = "▾";
    }
  }

  function hideAllDescendants(parentId) {
    const children = document.querySelectorAll('[data-parent="' + parentId + '"]');
    children.forEach(child => {
      child.classList.add("hidden");
      const childGroupId = child.getAttribute("data-group");
      const childIco = document.getElementById("ico-" + childGroupId);
      if (childIco) {
        childIco.textContent = "▸";
      }
      hideAllDescendants(childGroupId);
    });
  }

  function expandCollapseLevel(level, expand) {
    const headers = document.querySelectorAll(`[data-level="${level}"][data-is-header="True"]`);
    headers.forEach(row => {
      const groupId = row.getAttribute("data-group");
      const ico = document.getElementById("ico-" + groupId);
      if (expand) {
        if (ico) ico.textContent = "▾";
        const directChildren = document.querySelectorAll('[data-parent="' + groupId + '"]');
        directChildren.forEach(r => r.classList.remove("hidden"));
      } else {
        if (ico) ico.textContent = "▸";
        hideAllDescendants(groupId);
      }
    });
  }

  function expandAll() {
    document.querySelectorAll('[data-is-header="True"]').forEach(row => {
      const groupId = row.getAttribute("data-group");
      const ico = document.getElementById("ico-" + groupId);
      if (ico) ico.textContent = "▾";
      row.classList.remove("hidden");
    });
    document.querySelectorAll("#pivot-body tr").forEach(row => row.classList.remove("hidden"));
  }

  function collapseAll() {
    document.querySelectorAll('[data-is-header="True"]').forEach(row => {
      const groupId = row.getAttribute("data-group");
      const ico = document.getElementById("ico-" + groupId);
      if (ico) ico.textContent = "▸";
      const children = document.querySelectorAll('[data-parent="' + groupId + '"]');
      children.forEach(child => child.classList.add("hidden"));
    });
    document.querySelectorAll('[data-is-header="False"]').forEach(row => row.classList.add("hidden"));
    document.querySelectorAll('[data-level="0"]').forEach(row => row.classList.remove("hidden"));
  }

  function renderFieldChips() {
    const activeWrap = document.getElementById("row-fields");
    const availableWrap = document.getElementById("available-fields");
    activeWrap.innerHTML = "";
    availableWrap.innerHTML = "";

    const active = state.row_fields.slice();
    const available = FIELD_DEFS.map(f => f.id).filter(id => !active.includes(id));

    let dropTargetEl = null;
    function setDropTarget(nextEl) {
      if (dropTargetEl && dropTargetEl !== nextEl) dropTargetEl.classList.remove("is-drop-target");
      dropTargetEl = nextEl || null;
      if (dropTargetEl) dropTargetEl.classList.add("is-drop-target");
    }

	      function createChip(fieldId, listType) {
	        const def = FIELD_DEFS.find(f => f.id === fieldId);
	        const chip = document.createElement("div");
	        chip.className = "flex items-center gap-1 px-2 py-1 rounded-lg border bg-white text-xs cursor-move";
	        chip.draggable = !IS_TOUCH_UI;
	        chip.dataset.field = fieldId;
	        chip.dataset.list = listType;
	        chip.innerHTML = `<span class="text-slate-400 px-1.5 py-0.5 -mx-1 rounded-md" data-chip-handle>⋮⋮</span><span>${def ? def.label : fieldId}</span>`;

      if (!IS_TOUCH_UI) {
        chip.addEventListener("dragstart", e => {
          e.dataTransfer.setData("text/plain", fieldId);
          e.dataTransfer.setData("source", listType);
        });
        chip.addEventListener("dragover", e => e.preventDefault());
        chip.addEventListener("drop", e => {
          e.preventDefault();
          const field = e.dataTransfer.getData("text/plain");
          moveField(field, listType, fieldId);
        });
	      }

	      if (ENABLE_POINTER_DND) {
	        // Touch-friendly: drag via handle (⋮⋮); tap to add/remove quickly.
	        let pointerId = null;
	        let startX = 0;
	        let startY = 0;
	        let lastX = 0;
	        let lastY = 0;
	        let started = false;
	        let pressTimer = null;
	        let handleOnly = false;
	        let suppressClickUntil = 0;
	        let ghost = null;
	        let offsetX = 0;
	        let offsetY = 0;

	        function cancelPress() {
	          if (pressTimer) {
	            clearTimeout(pressTimer);
	            pressTimer = null;
	          }
	        }

	        function beginDrag(x, y) {
	          if (started) return;
	          started = true;
	          suppressClickUntil = Date.now() + 450;
	          chip.classList.add("chip-drag-source");
	          const rect = chip.getBoundingClientRect();
	          ghost = chip.cloneNode(true);
	          ghost.classList.add("chip-drag-ghost");
	          ghost.style.width = rect.width + "px";
	          ghost.style.height = rect.height + "px";
	          ghost.style.left = (x - offsetX) + "px";
	          ghost.style.top = (y - offsetY) + "px";
	          document.body.appendChild(ghost);
	          updateGhost(x, y);
	        }

	        function cleanup() {
	          cancelPress();
	          if (ghost && ghost.parentNode) ghost.parentNode.removeChild(ghost);
	          ghost = null;
	          chip.classList.remove("chip-drag-source");
	          setDropTarget(null);
	          pointerId = null;
	          handleOnly = false;
	          started = false;
	          startX = 0;
	          startY = 0;
	          lastX = 0;
	          lastY = 0;
	          offsetX = 0;
	          offsetY = 0;
	        }

	        function updateGhost(x, y) {
	          if (!ghost) return;
	          ghost.style.left = (x - offsetX) + "px";
	          ghost.style.top = (y - offsetY) + "px";
	        }

	        chip.addEventListener("contextmenu", (e) => {
	          if (pointerId != null) e.preventDefault();
	        });

	        chip.addEventListener("pointerdown", (ev) => {
	          if (!FORCE_TOUCH_DND && ev.pointerType !== "touch" && ev.pointerType !== "pen") return;
	          const handle = ev.target && ev.target.closest ? ev.target.closest("[data-chip-handle]") : null;
	          if (ev.button != null && ev.button !== 0) return;
	          const rect = chip.getBoundingClientRect();
	          pointerId = ev.pointerId;
	          startX = ev.clientX;
	          startY = ev.clientY;
	          lastX = ev.clientX;
	          lastY = ev.clientY;
	          started = false;
	          handleOnly = !!handle;
	          offsetX = ev.clientX - rect.left;
	          offsetY = ev.clientY - rect.top;
	          try { chip.setPointerCapture(pointerId); } catch (e) {}

	          cancelPress();
	          if (!handleOnly) {
	            // Allow long-press anywhere on the chip to start dragging (more discoverable on mobile).
	            pressTimer = setTimeout(() => {
	              if (pointerId == null) return;
	              beginDrag(lastX, lastY);
	              const el = document.elementFromPoint(lastX, lastY);
	              const drop = el && el.closest ? el.closest("#row-fields, #available-fields") : null;
	              setDropTarget(drop);
	            }, 220);
	          } else {
	            // Handle drag: prevent scroll immediately.
	            ev.preventDefault();
	          }
	        });

	        chip.addEventListener("pointermove", (ev) => {
	          if (pointerId == null || ev.pointerId !== pointerId) return;
	          lastX = ev.clientX;
	          lastY = ev.clientY;
	          const moved = Math.abs(ev.clientX - startX) + Math.abs(ev.clientY - startY);
	          if (!started) {
	            if (handleOnly) {
	              if (moved < 10) return;
	              beginDrag(ev.clientX, ev.clientY);
	            } else {
	              // If user starts scrolling, cancel long-press drag.
	              if (moved > 12) cancelPress();
	              return;
	            }
	          }
	          if (!started) return;
	          ev.preventDefault();
	          updateGhost(ev.clientX, ev.clientY);
	          const el = document.elementFromPoint(ev.clientX, ev.clientY);
	          const drop = el && el.closest ? el.closest("#row-fields, #available-fields") : null;
	          setDropTarget(drop);
	        }, { passive: false });

	        chip.addEventListener("pointerup", (ev) => {
	          if (pointerId == null || ev.pointerId !== pointerId) return;
	          const wasStarted = started;
	          const x = ev.clientX;
	          const y = ev.clientY;
	          cleanup();
	          if (!wasStarted) return;
	          const el = document.elementFromPoint(x, y);
	          const drop = el && el.closest ? el.closest("#row-fields, #available-fields") : null;
	          if (!drop) return;
	          const targetList = drop.id === "row-fields" ? "active" : "available";
	          const beforeField = targetList === "active"
	            ? getInsertBeforeField(drop, x, y, fieldId)
	            : null;
	          moveField(fieldId, targetList, beforeField);
	        });

        chip.addEventListener("pointercancel", (ev) => {
          if (pointerId == null || ev.pointerId !== pointerId) return;
          cleanup();
        });

        if (IS_TOUCH_UI) {
          chip.addEventListener("click", (e) => {
            if (Date.now() < suppressClickUntil) {
              e.preventDefault();
              e.stopPropagation();
              return;
            }
            if (listType === "available") {
              moveField(fieldId, "active", null);
            } else {
              moveField(fieldId, "available", null);
            }
          });
        }
      }
      return chip;
    }

    active.forEach(id => activeWrap.appendChild(createChip(id, "active")));
    available.forEach(id => availableWrap.appendChild(createChip(id, "available")));
  }

  function getInsertBeforeField(container, x, y, excludeFieldId) {
    const chips = Array.from(container.querySelectorAll("[data-field]"))
      .filter(chip => String(chip.dataset.field) !== String(excludeFieldId || ""));
    if (!chips.length) return null;
    let closest = null;
    let closestDist = Infinity;
    chips.forEach(chip => {
      const rect = chip.getBoundingClientRect();
      const cx = rect.left + rect.width / 2;
      const cy = rect.top + rect.height / 2;
      const dist = Math.hypot(x - cx, y - cy);
      if (dist < closestDist) {
        closestDist = dist;
        closest = chip;
      }
    });
    if (!closest) return null;
    const rect = closest.getBoundingClientRect();
    if (x < rect.left + rect.width / 2) {
      return closest.dataset.field;
    }
    const order = chips.map(chip => chip.dataset.field);
    const idx = order.indexOf(closest.dataset.field);
    return idx >= 0 && idx + 1 < order.length ? order[idx + 1] : null;
  }

  function moveField(fieldId, targetList, beforeField) {
    if (!FIELD_DEFS.find(f => f.id === fieldId)) return;
    const active = sanitizeRowFields(state.row_fields);
    const hasField = active.includes(fieldId);

    if (targetList === "available") {
      if (hasField) {
        setState({ row_fields: active.filter(f => f !== fieldId) });
      }
      renderFieldChips();
      renderPivot();
      return;
    }

    let next = active.filter(f => f !== fieldId);
    const insertIndex = beforeField ? next.indexOf(beforeField) : -1;
    if (insertIndex >= 0) {
      next.splice(insertIndex, 0, fieldId);
    } else {
      next.push(fieldId);
    }
    setState({ row_fields: next });
    renderFieldChips();
    renderPivot();
  }

  if (!IS_TOUCH_UI) {
    document.getElementById("row-fields").addEventListener("dragover", e => e.preventDefault());
    document.getElementById("row-fields").addEventListener("drop", e => {
      e.preventDefault();
      const field = e.dataTransfer.getData("text/plain");
      const beforeField = getInsertBeforeField(document.getElementById("row-fields"), e.clientX, e.clientY, field);
      moveField(field, "active", beforeField);
    });
    document.getElementById("available-fields").addEventListener("dragover", e => e.preventDefault());
    document.getElementById("available-fields").addEventListener("drop", e => {
      e.preventDefault();
      const field = e.dataTransfer.getData("text/plain");
      moveField(field, "available", null);
    });
  }

  document.getElementById("time-mode").addEventListener("change", () => {
    ensureDefaultTimeForMode(document.getElementById("time-mode").value, true);
    applyTimeModeUI();
    scheduleRefresh();
  });
  document.getElementById("start-date").addEventListener("change", scheduleRefresh);
  document.getElementById("end-date").addEventListener("change", scheduleRefresh);
  document.getElementById("year-select").addEventListener("change", () => {
    updateWeekOptions();
    scheduleRefresh();
  });
  document.getElementById("quarter-select").addEventListener("change", scheduleRefresh);
  document.getElementById("month-select").addEventListener("change", scheduleRefresh);
  document.getElementById("week-select").addEventListener("change", scheduleRefresh);
  document.getElementById("day-select").addEventListener("change", scheduleRefresh);
  document.getElementById("platform-filter").addEventListener("change", scheduleRefresh);
  document.getElementById("agent-filter").addEventListener("change", scheduleRefresh);
  document.getElementById("scenario-filter").addEventListener("change", scheduleRefresh);
  document.getElementById("satisfaction-filter").addEventListener("change", scheduleRefresh);

  document.getElementById("manual-refresh").addEventListener("click", refreshReport);
  document.getElementById("toggle-mom").addEventListener("click", () => {
    setState({ show_mom: !state.show_mom });
    updateToggleButtons();
  });
  document.getElementById("toggle-yoy").addEventListener("click", () => {
    setState({ show_yoy: !state.show_yoy });
    updateToggleButtons();
    scheduleRefresh();
  });

  document.getElementById("expand-all").addEventListener("click", expandAll);
  document.getElementById("collapse-all").addEventListener("click", collapseAll);
  document.getElementById("expand-level").addEventListener("click", () => {
    const level = Number(document.getElementById("level-select").value || 1);
    expandCollapseLevel(level, true);
  });
  document.getElementById("collapse-level").addEventListener("click", () => {
    const level = Number(document.getElementById("level-select").value || 1);
    expandCollapseLevel(level, false);
  });

  function showRule(btn) {
    const title = btn.getAttribute("data-rule-title") || "判定标准";
    const text = btn.getAttribute("data-rule-text") || "未配置";
    document.getElementById("rule-title").textContent = title;
    document.getElementById("rule-text").textContent = text;
    const modal = document.getElementById("rule-modal");
    modal.classList.remove("hidden");
    modal.classList.add("flex");
  }

  function closeRule() {
    const modal = document.getElementById("rule-modal");
    modal.classList.add("hidden");
    modal.classList.remove("flex");
  }

  document.getElementById("rule-modal").addEventListener("click", function(e){
    if (e.target && e.target.id === "rule-modal") closeRule();
  });

  const cidListState = {
    params: null,
    page: 1,
    per_page: 20,
    total: 0,
    title_base: "对话列表",
  };

  function renderCidListRows(items) {
    const tbody = document.getElementById("cid-list-tbody");
    if (!tbody) return;
    tbody.innerHTML = "";
    (items || []).forEach(item => {
      const tr = document.createElement("tr");
      tr.className = "hover:bg-slate-50";

      const tdTime = document.createElement("td");
      tdTime.className = "py-2 pr-3 whitespace-nowrap text-slate-700";
      tdTime.textContent = item.event_time || "";
      tdTime.title = [
        item.started_at ? ("开始: " + item.started_at) : "",
        item.ended_at ? ("结束: " + item.ended_at) : "",
        item.uploaded_at ? ("上传: " + item.uploaded_at) : "",
      ].filter(Boolean).join(" · ");

      const tdCid = document.createElement("td");
      tdCid.className = "py-2 pr-3 whitespace-nowrap";
      const a = document.createElement("a");
      a.href = "#";
      a.className = "cid-link text-indigo-600 hover:underline";
      a.dataset.cid = String(item.cid || "");
      a.textContent = "CID=" + String(item.cid || "");
      tdCid.appendChild(a);

      const tdPlatform = document.createElement("td");
      tdPlatform.className = "py-2 pr-3 whitespace-nowrap";
      tdPlatform.textContent = item.platform || "";

      const tdAgent = document.createElement("td");
      tdAgent.className = "py-2 pr-3 whitespace-nowrap";
      tdAgent.textContent = item.agent_name || item.agent_account || "";

      const tdBuyer = document.createElement("td");
      tdBuyer.className = "py-2 pr-3 whitespace-nowrap";
      tdBuyer.textContent = item.buyer_id || "";

      const tdMsg = document.createElement("td");
      tdMsg.className = "py-2 pr-3 whitespace-nowrap text-slate-700";
      tdMsg.textContent = (item.message_count === null || item.message_count === undefined) ? "" : String(item.message_count);

      const tdScenario = document.createElement("td");
      tdScenario.className = "py-2 pr-3 whitespace-nowrap";
      tdScenario.textContent = item.reception_scenario || "";

      const tdSatis = document.createElement("td");
      tdSatis.className = "py-2 pr-3 whitespace-nowrap";
      tdSatis.textContent = item.satisfaction_change || "";

      tr.appendChild(tdTime);
      tr.appendChild(tdCid);
      tr.appendChild(tdPlatform);
      tr.appendChild(tdAgent);
      tr.appendChild(tdBuyer);
      tr.appendChild(tdMsg);
      tr.appendChild(tdScenario);
      tr.appendChild(tdSatis);
      tbody.appendChild(tr);
    });
  }

  function updateCidPager() {
    const pager = document.getElementById("cid-list-pager");
    const info = document.getElementById("cid-page-info");
    const prevBtn = document.getElementById("cid-prev");
    const nextBtn = document.getElementById("cid-next");
    if (!pager || !info || !prevBtn || !nextBtn) return;

    const total = Number(cidListState.total || 0);
    const perPage = Number(cidListState.per_page || 20);
    const page = Number(cidListState.page || 1);
    const totalPages = total > 0 ? Math.ceil(total / perPage) : 1;

    if (total <= 0) {
      pager.classList.add("hidden");
      return;
    }
    pager.classList.remove("hidden");

    info.textContent = `第 ${page} / ${totalPages} 页 · 共 ${total} 条`;
    prevBtn.disabled = page <= 1;
    nextBtn.disabled = page >= totalPages;
  }

  function setCidListLoading(isLoading) {
    const loading = document.getElementById("cid-list-loading");
    const empty = document.getElementById("cid-list-empty");
    const content = document.getElementById("cid-list-content");
    const pager = document.getElementById("cid-list-pager");
    if (isLoading) {
      loading.classList.remove("hidden");
      empty.classList.add("hidden");
      content.classList.add("hidden");
      if (pager) pager.classList.add("hidden");
      return;
    }
    loading.classList.add("hidden");
  }

  async function loadCidListPage(page) {
    if (!cidListState.params) return;
    cidListState.page = page;
    const params = new URLSearchParams(cidListState.params.toString());
    params.set("page", String(cidListState.page));
    params.set("per_page", String(cidListState.per_page));

    setCidListLoading(true);
    try {
      const response = await fetch("/api/reports/tags/conversations?" + params.toString());
      const data = await response.json();

      const items = Array.isArray(data.items) ? data.items : [];
      const cids = Array.isArray(data.cids) ? data.cids : [];
      const total = (data.total !== undefined && data.total !== null) ? Number(data.total) : (items.length || cids.length);
      cidListState.total = isNaN(total) ? (items.length || cids.length) : total;

      const title = document.getElementById("cid-list-title");
      const baseTitle = cidListState.title_base || "对话列表";
      if (title) title.textContent = `${baseTitle}（共 ${cidListState.total} 条）`;

      const empty = document.getElementById("cid-list-empty");
      const content = document.getElementById("cid-list-content");
      if ((items && items.length > 0) || (cids && cids.length > 0)) {
        const normalized = items.length > 0
          ? items
          : cids.map(cid => ({ cid, event_time: "", platform: "", agent_name: "", buyer_id: "", message_count: "", reception_scenario: "", satisfaction_change: "" }));
        renderCidListRows(normalized);
        empty.classList.add("hidden");
        content.classList.remove("hidden");
      } else {
        renderCidListRows([]);
        content.classList.add("hidden");
        empty.classList.remove("hidden");
      }

      setCidListLoading(false);
      updateCidPager();
    } catch (error) {
      const empty = document.getElementById("cid-list-empty");
      const content = document.getElementById("cid-list-content");
      const loading = document.getElementById("cid-list-loading");
      if (loading) loading.classList.add("hidden");
      if (content) content.classList.add("hidden");
      if (empty) {
        empty.textContent = "加载失败：" + (error && error.message ? error.message : String(error));
        empty.classList.remove("hidden");
      }
      cidListState.total = 0;
      updateCidPager();
    }
  }

  async function showTagCids(btn) {
    const tagId = btn.getAttribute("data-tag-id");
    if (!tagId) return;
    const platform = btn.getAttribute("data-platform");
    const agentUserId = btn.getAttribute("data-agent-user-id");
    const scenario = btn.getAttribute("data-scenario");
    const satisfaction = btn.getAttribute("data-satisfaction");

    const params = new URLSearchParams();
    params.append("tag_id", tagId);
    const start = document.getElementById("start-date").value;
    const end = document.getElementById("end-date").value;
    if (start) params.append("start", start);
    if (end) params.append("end", end);
    if (platform) params.append("platform", platform);
    if (agentUserId) params.append("agent_user_id", agentUserId);
    if (scenario) params.append("reception_scenario", scenario);
    if (satisfaction) params.append("satisfaction_change", satisfaction);

    await openCidList(params, "命中标签的对话列表");
  }

  async function showQcCids(btn) {
    const tagId = btn.getAttribute("data-tag-id") || "";
    const categoryId = btn.getAttribute("data-category-id") || "";
    const platform = btn.getAttribute("data-platform");
    const agentUserId = btn.getAttribute("data-agent-user-id");
    const scenario = btn.getAttribute("data-scenario");
    const satisfaction = btn.getAttribute("data-satisfaction");

    const params = new URLSearchParams();
    let titleBase = "质检对话列表";
    if (tagId) {
      params.append("tag_id", tagId);
      titleBase = "命中标签的对话列表";
    } else if (categoryId) {
      params.append("category_id", categoryId);
      titleBase = "命中标签分类的对话列表";
    }

    const start = document.getElementById("start-date").value;
    const end = document.getElementById("end-date").value;
    if (start) params.append("start", start);
    if (end) params.append("end", end);
    if (platform) params.append("platform", platform);
    if (agentUserId) params.append("agent_user_id", agentUserId);
    if (scenario) params.append("reception_scenario", scenario);
    if (satisfaction) params.append("satisfaction_change", satisfaction);

    await openCidList(params, titleBase);
  }

  async function openCidList(params, titleBase) {
    const modal = document.getElementById("cid-list-modal");
    const title = document.getElementById("cid-list-title");

    modal.classList.remove("hidden");
    modal.classList.add("flex");

    cidListState.title_base = titleBase || "对话列表";
    if (title) title.textContent = cidListState.title_base;

    cidListState.params = params;
    cidListState.page = 1;
    cidListState.total = 0;
    setCidListLoading(true);
    await loadCidListPage(1);
  }

  function closeCidList() {
    const modal = document.getElementById("cid-list-modal");
    modal.classList.add("hidden");
    modal.classList.remove("flex");
    cidListState.params = null;
    cidListState.page = 1;
    cidListState.total = 0;
    cidListState.title_base = "对话列表";
    const empty = document.getElementById("cid-list-empty");
    if (empty) empty.textContent = "暂无数据";
  }

  document.getElementById("cid-list-modal")?.addEventListener("click", function(e){
    if (e.target && e.target.id === "cid-list-modal") closeCidList();
  });

  document.getElementById("cid-prev")?.addEventListener("click", function () {
    if (cidListState.page > 1) loadCidListPage(cidListState.page - 1);
  });
  document.getElementById("cid-next")?.addEventListener("click", function () {
    const total = Number(cidListState.total || 0);
    const perPage = Number(cidListState.per_page || 20);
    const totalPages = total > 0 ? Math.ceil(total / perPage) : 1;
    if (cidListState.page < totalPages) loadCidListPage(cidListState.page + 1);
  });

  loadState();
  applyStateToFilters();
  renderFieldChips();
  refreshReport();
</script>

{% endblock %}
