{% extends "base.html" %}
{% block content %}
<div class="max-w-5xl mx-auto space-y-4">
  <div class="flex items-start justify-between gap-4">
    <div>
      <div class="text-sm text-slate-500"><a class="underline" href="/reports/daily-ai">← 返回历史列表</a></div>
      <h1 class="text-2xl font-semibold mt-1">每日AI总结：{{ report.run_date }}</h1>
      <div class="text-sm text-slate-500 mt-1">
        纳入：{{ report.included_conversations }} 个对话 / {{ report.included_messages }} 条消息 · 输入字符约 {{ report.input_chars }}
        · 模型：<span class="font-mono">{{ report.model or "-" }}</span>
      </div>
    </div>
    <div class="flex items-center gap-2">
      <a href="/settings/ai/daily?date={{ report.run_date }}" class="px-4 py-2 rounded-xl border bg-white text-sm hover:bg-slate-50">去重新生成</a>
      <button id="shareDailyBtn" class="px-4 py-2 rounded-xl border bg-white text-sm hover:bg-slate-50">分享</button>
      <a href="/reports/daily-ai/{{ report.run_date }}/export" class="px-4 py-2 rounded-xl bg-slate-900 text-white text-sm">导出TXT</a>
    </div>
  </div>

  <div class="bg-white border rounded-2xl p-4">
    <div class="prose max-w-none">
      {{ html_body | safe }}
    </div>
  </div>
</div>

  <div id="shareDailyModal" class="fixed inset-0 z-[70] hidden" aria-hidden="true">
    <div id="shareDailyBackdrop" class="absolute inset-0 bg-slate-900/40"></div>
    <div class="absolute inset-0 flex items-center justify-center p-4">
      <div class="w-full max-w-xl bg-white rounded-2xl shadow-xl border overflow-hidden">
        <div class="px-4 py-3 border-b flex items-center justify-between gap-3">
          <div class="font-semibold">分享这份日报</div>
          <button id="shareDailyClose" class="px-3 py-1.5 rounded-lg bg-white border text-sm hover:bg-slate-50">关闭</button>
        </div>
        <div class="p-4 space-y-3">
          <div class="text-sm text-slate-600">生成一个任何人都能访问的查看页链接（分享页右上角也可以登录）。</div>
          <div class="flex items-center gap-2">
            <input id="shareDailyUrl" class="w-full px-3 py-2 rounded-xl border bg-slate-50 text-sm" readonly value="" placeholder="点击「生成链接」" />
            <button id="shareDailyCopy" class="px-3 py-2 rounded-xl bg-slate-900 text-white text-sm">复制</button>
          </div>
          <div class="flex items-center gap-2">
            <button id="shareDailyCreate" class="px-4 py-2 rounded-xl border bg-white text-sm hover:bg-slate-50">生成链接</button>
            <a id="shareDailyOpen" href="#" target="_blank" class="px-4 py-2 rounded-xl bg-slate-900 text-white text-sm hidden">打开分享页</a>
            <div id="shareDailyHint" class="text-sm text-slate-500"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

<script>
(function(){
  const btn = document.getElementById('shareDailyBtn');
  const modal = document.getElementById('shareDailyModal');
  const backdrop = document.getElementById('shareDailyBackdrop');
  const closeBtn = document.getElementById('shareDailyClose');
  const createBtn = document.getElementById('shareDailyCreate');
  const copyBtn = document.getElementById('shareDailyCopy');
  const openA = document.getElementById('shareDailyOpen');
  const urlInput = document.getElementById('shareDailyUrl');
  const hint = document.getElementById('shareDailyHint');

  function open(){ modal.classList.remove('hidden'); }
  function close(){ modal.classList.add('hidden'); }

  async function createDailyShareLink(){
    hint.textContent = '生成中…';
    openA.classList.add('hidden');
    try{
      const resp = await fetch('/api/reports/daily-ai/{{ report.run_date }}/share', { method: 'POST' });
      if(!resp.ok){
        const j = await resp.json().catch(()=>null);
        throw new Error((j && (j.detail || j.message)) || ('HTTP ' + resp.status));
      }
      const data = await resp.json();
      urlInput.value = data.url || '';
      if(urlInput.value){
        openA.href = urlInput.value;
        openA.classList.remove('hidden');
        hint.textContent = '已生成，可复制或直接打开。';
      }else{
        hint.textContent = '生成成功，但未返回链接。';
      }
    }catch(e){
      hint.textContent = '生成失败：' + (e && e.message ? e.message : '未知错误');
    }
  }

  async function copy(){
    const v = (urlInput.value || '').trim();
    if(!v){ hint.textContent = '还没有链接，先点「生成链接」。'; return; }
    try{
      await navigator.clipboard.writeText(v);
      hint.textContent = '已复制到剪贴板。';
    }catch(e){
      // Fallback
      urlInput.focus(); urlInput.select();
      document.execCommand('copy');
      hint.textContent = '已复制。';
    }
  }

  btn && btn.addEventListener('click', open);
  backdrop && backdrop.addEventListener('click', close);
  closeBtn && closeBtn.addEventListener('click', close);
  createBtn && createBtn.addEventListener('click', createDailyShareLink);
  copyBtn && copyBtn.addEventListener('click', copy);
})();
</script>

{% endblock %}
