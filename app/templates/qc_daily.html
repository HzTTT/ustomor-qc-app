{% extends "base.html" %}
{% block content %}
<div class="flex flex-col md:flex-row md:items-start md:justify-between gap-4 mb-4">
  <div>
    <h1 class="text-2xl font-semibold">AI质检</h1>
    <div class="text-sm text-slate-500 mt-1">
      筛选时间范围内、消息数≥{{ threshold_messages }} 的对话，默认已帮你圈选可质检的对话。
      <span class="font-medium text-slate-700">共 {{ total_count }} 条对话 · {{ total_message_count }} 条消息</span>
    </div>
  </div>
  <div class="flex items-center gap-2">
    <a href="/conversations" class="px-3 py-2 rounded-xl border bg-white text-sm hover:bg-slate-50">聊天记录</a>
  </div>
</div>

{% if ok %}
  <div class="mb-4 px-4 py-2 rounded-xl bg-green-50 border border-green-200 text-green-800 text-sm">{{ ok }}</div>
{% endif %}
{% if error %}
  <div class="mb-4 px-4 py-2 rounded-xl bg-red-50 border border-red-200 text-red-800 text-sm">{{ error }}</div>
{% endif %}

<div class="bg-white border rounded-2xl p-4 mb-6">
  <form method="get" action="/qc/daily" class="flex flex-wrap items-end gap-3">
    <div>
      <label class="block text-xs text-slate-500 mb-1">开始日期</label>
      <input type="date" name="start_date" value="{{ start_date }}" class="px-3 py-2 rounded-xl border" />
    </div>
    <div>
      <label class="block text-xs text-slate-500 mb-1">结束日期</label>
      <input type="date" name="end_date" value="{{ end_date }}" class="px-3 py-2 rounded-xl border" />
    </div>
    <div>
      <label class="block text-xs text-slate-500 mb-1">消息数阈值</label>
      <input type="number" name="min_messages" value="{{ threshold_messages }}" min="1" max="500" class="px-3 py-2 rounded-xl border w-28" />
    </div>
    <div>
      <label class="block text-xs text-slate-500 mb-1">是否已AI质检</label>
      <select name="has_analysis" class="px-3 py-2 rounded-xl border text-sm">
        <option value="">全部</option>
        <option value="1" {% if has_analysis == "1" %}selected{% endif %}>已质检</option>
        <option value="0" {% if has_analysis == "0" %}selected{% endif %}>未质检</option>
      </select>
    </div>
    <div>
      <label class="block text-xs text-slate-500 mb-1">每页显示</label>
      <select name="per_page" class="px-3 py-2 rounded-xl border text-sm w-24">
        <option value="20" {% if per_page == 20 %}selected{% endif %}>20</option>
        <option value="50" {% if per_page == 50 %}selected{% endif %}>50</option>
        <option value="100" {% if per_page == 100 %}selected{% endif %}>100</option>
        <option value="200" {% if per_page == 200 %}selected{% endif %}>200</option>
      </select>
    </div>
    <button type="submit" class="px-4 py-2 rounded-xl bg-slate-900 text-white text-sm">筛选</button>
  </form>
</div>

<form method="post" action="/qc/daily/batch" id="qc-batch-form">
  <input type="hidden" name="start_date" value="{{ start_date }}" />
  <input type="hidden" name="end_date" value="{{ end_date }}" />
  <input type="hidden" name="min_messages" value="{{ threshold_messages }}" />
  <input type="hidden" name="page" value="{{ current_page }}" />
  <input type="hidden" name="per_page" value="{{ per_page }}" />
  <div class="mb-3 flex flex-wrap items-center gap-2">
    <button type="button" id="select-all" class="px-3 py-1.5 rounded-xl border bg-white text-sm hover:bg-slate-50">全选</button>
    <button type="button" id="invert" class="px-3 py-1.5 rounded-xl border bg-white text-sm hover:bg-slate-50">反选</button>
    <span class="text-sm text-slate-500">圈选：按住 Shift 点击行可连续勾选</span>
    <button type="submit" id="submit-batch" class="px-4 py-2 rounded-xl bg-slate-900 text-white text-sm">批量质检</button>
  </div>

  <div class="bg-white border rounded-2xl overflow-hidden">
    <div class="overflow-x-auto">
    <table class="w-full text-sm min-w-[760px]" id="qc-table">
      <thead class="bg-slate-50">
        <tr>
          <th class="text-left px-4 py-3 w-10">
            <input type="checkbox" id="head-cb" title="全选" />
          </th>
          <th class="text-left px-4 py-3">对话</th>
          <th class="text-left px-4 py-3">平台</th>
          <th class="text-left px-4 py-3">消息数</th>
          <th class="text-left px-4 py-3">状态</th>
          <th class="text-left px-4 py-3">操作</th>
        </tr>
      </thead>
      <tbody>
        {% for c in convos %}
          <tr class="border-t qc-row" data-id="{{ c.id }}">
            <td class="px-4 py-3">
              <input type="checkbox" name="conversation_ids" value="{{ c.id }}" class="qc-cb" {% if c.id in pending_ids %}disabled{% else %}checked{% endif %} />
            </td>
            <td class="px-4 py-3 font-mono text-slate-700">{{ c.external_id or c.id }}</td>
            <td class="px-4 py-3 text-slate-600">{{ c.platform or '-' }}</td>
            <td class="px-4 py-3">{{ rounds_by_conv.get(c.id, 0) }}</td>
            <td class="px-4 py-3">
              {% if c.id in pending_ids %}
                <span class="text-amber-600 text-xs">待质检</span>
              {% else %}
                <span class="text-slate-400 text-xs">可选</span>
              {% endif %}
            </td>
            <td class="px-4 py-3">
              <a href="/conversations/{{ c.id }}" class="text-sky-600 hover:underline text-xs">查看</a>
            </td>
          </tr>
        {% endfor %}
        {% if convos|length == 0 %}
          <tr class="border-t">
            <td colspan="6" class="px-4 py-6 text-slate-500">该时间范围内暂无消息数≥{{ threshold_messages }} 的对话</td>
          </tr>
        {% endif %}
      </tbody>
    </table>
    </div>
  </div>

  <div class="mt-4 flex flex-wrap items-center justify-between gap-3">
    <div class="text-sm text-slate-500">
      第 {{ current_page }} / {{ total_pages }} 页，共 {{ total_count }} 条对话 · {{ total_message_count }} 条消息
      （当前页 {{ convos|length }} 条对话 · {{ page_message_count }} 条消息）
    </div>
    <div class="flex items-center gap-2">
      {% if current_page > 1 %}
        <a href="?start_date={{ start_date }}&end_date={{ end_date }}&min_messages={{ threshold_messages }}&has_analysis={{ has_analysis }}&per_page={{ per_page }}&page=1" 
           class="px-3 py-1.5 rounded-xl border bg-white text-sm hover:bg-slate-50">首页</a>
        <a href="?start_date={{ start_date }}&end_date={{ end_date }}&min_messages={{ threshold_messages }}&has_analysis={{ has_analysis }}&per_page={{ per_page }}&page={{ current_page - 1 }}" 
           class="px-3 py-1.5 rounded-xl border bg-white text-sm hover:bg-slate-50">上一页</a>
      {% else %}
        <span class="px-3 py-1.5 rounded-xl border bg-slate-100 text-slate-400 text-sm">首页</span>
        <span class="px-3 py-1.5 rounded-xl border bg-slate-100 text-slate-400 text-sm">上一页</span>
      {% endif %}

      {% set start_page = [1, current_page - 2]|max %}
      {% set end_page = [total_pages, current_page + 2]|min %}
      
      {% for p in range(start_page, end_page + 1) %}
        {% if p == current_page %}
          <span class="px-3 py-1.5 rounded-xl bg-slate-900 text-white text-sm font-medium">{{ p }}</span>
        {% else %}
          <a href="?start_date={{ start_date }}&end_date={{ end_date }}&min_messages={{ threshold_messages }}&has_analysis={{ has_analysis }}&per_page={{ per_page }}&page={{ p }}" 
             class="px-3 py-1.5 rounded-xl border bg-white text-sm hover:bg-slate-50">{{ p }}</a>
        {% endif %}
      {% endfor %}

      {% if current_page < total_pages %}
        <a href="?start_date={{ start_date }}&end_date={{ end_date }}&min_messages={{ threshold_messages }}&has_analysis={{ has_analysis }}&per_page={{ per_page }}&page={{ current_page + 1 }}" 
           class="px-3 py-1.5 rounded-xl border bg-white text-sm hover:bg-slate-50">下一页</a>
        <a href="?start_date={{ start_date }}&end_date={{ end_date }}&min_messages={{ threshold_messages }}&has_analysis={{ has_analysis }}&per_page={{ per_page }}&page={{ total_pages }}" 
           class="px-3 py-1.5 rounded-xl border bg-white text-sm hover:bg-slate-50">末页</a>
      {% else %}
        <span class="px-3 py-1.5 rounded-xl border bg-slate-100 text-slate-400 text-sm">下一页</span>
        <span class="px-3 py-1.5 rounded-xl border bg-slate-100 text-slate-400 text-sm">末页</span>
      {% endif %}
    </div>
  </div>
</form>

<script>
(function () {
  const form = document.getElementById('qc-batch-form');
  const headCb = document.getElementById('head-cb');
  const selectAllBtn = document.getElementById('select-all');
  const invertBtn = document.getElementById('invert');
  const rows = document.querySelectorAll('.qc-row');
  const cbs = document.querySelectorAll('.qc-cb:not([disabled])');

  function updateHeadCb() {
    if (!headCb) return;
    const enabled = document.querySelectorAll('.qc-cb:not([disabled])');
    const checked = document.querySelectorAll('.qc-cb:not([disabled]):checked');
    headCb.checked = enabled.length > 0 && checked.length === enabled.length;
    headCb.indeterminate = checked.length > 0 && checked.length < enabled.length;
  }

  if (headCb) {
    headCb.addEventListener('change', function () {
      cbs.forEach(function (cb) { cb.checked = headCb.checked; });
    });
  }

  if (selectAllBtn) {
    selectAllBtn.addEventListener('click', function () {
      cbs.forEach(function (cb) { cb.checked = true; });
      if (headCb) headCb.checked = true;
      headCb && (headCb.indeterminate = false);
    });
  }

  if (invertBtn) {
    invertBtn.addEventListener('click', function () {
      cbs.forEach(function (cb) { cb.checked = !cb.checked; });
      updateHeadCb();
    });
  }

  var lastShiftRow = null;
  rows.forEach(function (row) {
    const cb = row.querySelector('.qc-cb');
    if (!cb || cb.disabled) return;
    row.style.cursor = 'pointer';
    row.addEventListener('click', function (e) {
      if (e.target.tagName === 'A' || e.target.tagName === 'INPUT') return;
      if (e.shiftKey && lastShiftRow != null) {
        e.preventDefault();
        var r = Array.prototype.indexOf.call(rows, row);
        var l = Array.prototype.indexOf.call(rows, lastShiftRow);
        var lo = Math.min(r, l), hi = Math.max(r, l);
        for (var i = lo; i <= hi; i++) {
          var c = rows[i].querySelector('.qc-cb');
          if (c && !c.disabled) c.checked = true;
        }
        updateHeadCb();
        return;
      }
      lastShiftRow = row;
      cb.checked = !cb.checked;
      updateHeadCb();
    });
  });

  cbs.forEach(function (cb) {
    cb.addEventListener('change', updateHeadCb);
  });

  if (form) {
    form.addEventListener('submit', function (e) {
      var n = document.querySelectorAll('.qc-cb:checked').length;
      if (n === 0) {
        e.preventDefault();
        alert('请至少勾选一条对话');
        return false;
      }
    });
  }

  updateHeadCb();
})();
</script>
{% endblock %}
