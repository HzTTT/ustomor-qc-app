{% extends "base.html" %}
{% block content %}
<div class="flex items-end justify-between mb-4">
  <div>
    <h1 class="text-2xl font-semibold">同步概览</h1>
    <p class="text-sm text-slate-500 mt-1">
      扫描间隔：{{ cron_interval }} 秒 · 桶：{{ bucket_name or "(未配置 BUCKET_NAME)" }}{% if bucket_prefix %} / {{ bucket_prefix }}{% endif %}
    </p>
  </div>
  <div class="flex items-center gap-2">
    <a href="/settings/ai" class="px-3 py-2 rounded-xl border bg-white text-sm hover:bg-slate-50">AI配置</a>
    <a href="/conversations" class="px-3 py-2 rounded-xl border bg-white text-sm hover:bg-slate-50">聊天记录</a>
  </div>
</div>

<div class="grid grid-cols-1 md:grid-cols-3 gap-3 mb-4">
  <div class="bg-white border rounded-2xl p-4">
    <div class="text-xs text-slate-500">自动分析开关</div>
    {% if cfg.auto_analysis_enabled %}
      <div class="mt-1 inline-flex items-center gap-2 text-sm font-medium text-green-700">
        <span class="w-2 h-2 rounded-full bg-green-600"></span> 已开启
      </div>
    {% else %}
      <div class="mt-1 inline-flex items-center gap-2 text-sm font-medium text-slate-600">
        <span class="w-2 h-2 rounded-full bg-slate-400"></span> 已关闭
      </div>
    {% endif %}
    <div class="mt-2 text-xs text-slate-500">可在“AI配置”页面切换</div>
  </div>
  <div class="bg-white border rounded-2xl p-4">
    <div class="text-xs text-slate-500">AI任务状态</div>
    <div class="mt-2 flex items-center gap-3 text-sm">
      <div>pending <span class="font-semibold">{{ job_stats.pending }}</span></div>
      <div>running <span class="font-semibold">{{ job_stats.running }}</span></div>
      <div>error <span class="font-semibold">{{ job_stats.error }}</span></div>
    </div>
  </div>
  <div class="bg-white border rounded-2xl p-4">
    <div class="text-xs text-slate-500">轮询间隔（可在「应用设置」修改）</div>
    <div class="mt-2 text-sm">Cron: <span class="font-semibold">{{ cron_interval }}</span> 秒 / Worker: <span class="font-semibold">{{ worker_poll }}</span> 秒</div>
  </div>
</div>

<div class="bg-white border rounded-2xl overflow-hidden">
  <div class="px-4 py-3 border-b bg-slate-50">
    <div class="font-medium text-sm">桶同步记录（最新在前）</div>
    <div class="text-xs text-slate-500 mt-1">只记录“看到并尝试处理过”的对象：new/downloaded/imported/error</div>
  </div>
  <div class="overflow-auto">
    <table class="w-full text-sm">
      <thead class="bg-slate-50 sticky top-0">
        <tr>
          <th class="text-left px-4 py-3">时间</th>
          <th class="text-left px-4 py-3">状态</th>
          <th class="text-left px-4 py-3">对象Key</th>
          <th class="text-left px-4 py-3">ETag</th>
          <th class="text-right px-4 py-3">大小</th>
          <th class="text-left px-4 py-3">LastModified</th>
          <th class="text-left px-4 py-3">导入</th>
          <th class="text-left px-4 py-3">错误</th>
        </tr>
      </thead>
      <tbody>
        {% for r in bucket_rows %}
          <tr class="border-t">
            <td class="px-4 py-3 text-xs text-slate-500">{{ r.created_at.strftime('%Y-%m-%d %H:%M:%S') }}</td>
            <td class="px-4 py-3">
              {% if r.status == 'imported' %}
                <span class="px-2 py-1 rounded-full bg-green-50 text-green-700 text-xs">imported</span>
              {% elif r.status == 'downloaded' %}
                <span class="px-2 py-1 rounded-full bg-blue-50 text-blue-700 text-xs">downloaded</span>
              {% elif r.status == 'error' %}
                <span class="px-2 py-1 rounded-full bg-red-50 text-red-700 text-xs">error</span>
              {% else %}
                <span class="px-2 py-1 rounded-full bg-slate-100 text-slate-700 text-xs">{{ r.status }}</span>
              {% endif %}
            </td>
            <td class="px-4 py-3 font-mono text-xs break-all">{{ r.key }}</td>
            <td class="px-4 py-3 font-mono text-xs">{{ (r.etag or '')[:16] }}</td>
            <td class="px-4 py-3 text-right text-xs">{{ r.size }}</td>
            <td class="px-4 py-3 text-xs">{% if r.last_modified %}{{ r.last_modified.strftime('%Y-%m-%d %H:%M:%S') }}{% else %}-{% endif %}</td>
            <td class="px-4 py-3 text-xs">{% if r.imported_at %}{{ r.imported_at.strftime('%Y-%m-%d %H:%M:%S') }}{% else %}-{% endif %}</td>
            <td class="px-4 py-3 text-xs text-red-700">{{ r.error or '' }}</td>
          </tr>
        {% endfor %}
        {% if bucket_rows|length == 0 %}
          <tr><td colspan="8" class="px-4 py-6 text-sm text-slate-500">暂无同步记录（请确认 cron_runner 是否启动，且 BUCKET_* 已正确配置）</td></tr>
        {% endif %}
      </tbody>
    </table>
  </div>
</div>
{% endblock %}
