{% extends "base.html" %}
{% block content %}
<div class="flex flex-col md:flex-row md:items-start md:justify-between gap-4 mb-4">
  <div>
    <h1 class="text-2xl font-semibold">驳回标签管理</h1>
    <div class="text-sm text-slate-500 mt-1">维护“已驳回/屏蔽”标签清单，用于让 AI 不再建议相近标签。</div>
  </div>
  <div class="flex items-center gap-2">
    <a href="/settings/tag-suggestions" class="px-3 py-2 rounded-xl border bg-white text-sm hover:bg-slate-50">返回标签建议</a>
  </div>
</div>

{% if ok %}
  <div class="mb-4 px-4 py-2 rounded-xl bg-green-50 border border-green-200 text-green-800 text-sm">{{ ok }}</div>
{% endif %}
{% if error %}
  <div class="mb-4 px-4 py-2 rounded-xl bg-red-50 border border-red-200 text-red-800 text-sm">{{ error }}</div>
{% endif %}

<form method="get" action="/settings/rejected-tags" class="mb-4 bg-white border rounded-2xl p-4 flex flex-wrap gap-3 items-end">
  <div>
    <label class="block text-xs text-slate-500 mb-1">搜索</label>
    <input type="text" name="q" value="{{ q or '' }}" class="px-3 py-2 rounded-xl border text-sm w-64" placeholder="分类/标签/别名/备注" />
  </div>
  <div>
    <label class="block text-xs text-slate-500 mb-1">状态</label>
    <select name="status_filter" class="px-3 py-2 rounded-xl border text-sm">
      <option value="" {% if not status_filter %}selected{% endif %}>全部</option>
      <option value="active" {% if status_filter == 'active' %}selected{% endif %}>启用</option>
      <option value="inactive" {% if status_filter == 'inactive' %}selected{% endif %}>停用</option>
    </select>
  </div>
  <button type="submit" class="px-4 py-2 rounded-xl bg-slate-900 text-white text-sm">筛选</button>
  <a href="/settings/rejected-tags" class="px-4 py-2 rounded-xl border text-sm hover:bg-slate-50">重置</a>
</form>

<div class="bg-white border rounded-2xl p-4 mb-4">
  <div class="text-sm font-medium mb-3">新增驳回规则</div>
  <form action="/settings/rejected-tags/create" method="post" class="grid grid-cols-1 md:grid-cols-2 gap-3">
    <div>
      <label class="block text-xs text-slate-500 mb-1">一级分类</label>
      <input type="text" name="category" class="w-full px-3 py-2 rounded-xl border text-sm" placeholder="例如：客服接待" />
    </div>
    <div>
      <label class="block text-xs text-slate-500 mb-1">二级标签名</label>
      <input type="text" name="tag_name" class="w-full px-3 py-2 rounded-xl border text-sm" placeholder="例如：展期咨询" />
    </div>
    <div class="md:col-span-2">
      <label class="block text-xs text-slate-500 mb-1">别名/近似词（可选）</label>
      <textarea name="aliases" rows="2" class="w-full px-3 py-2 rounded-xl border text-sm" placeholder="逗号/分号/换行分隔，例如：催发货，催促发货"></textarea>
    </div>
    <div class="md:col-span-2">
      <label class="block text-xs text-slate-500 mb-1">备注（可选）</label>
      <input type="text" name="notes" class="w-full px-3 py-2 rounded-xl border text-sm" placeholder="驳回原因或规则说明" />
    </div>
    <div class="md:col-span-2 flex items-center gap-2">
      <label class="flex items-center gap-2 text-sm">
        <input type="checkbox" name="is_active" checked />
        启用
      </label>
      <button type="submit" class="px-4 py-2 rounded-xl bg-green-600 text-white text-sm">添加</button>
    </div>
  </form>
</div>

<div class="space-y-4">
  {% for r in rules %}
    <div class="bg-white border rounded-2xl p-4">
      <div class="flex items-start justify-between gap-3">
        <div class="min-w-0">
          <div class="text-sm font-medium">
            <span class="text-slate-500">分类</span> {{ r.category or '-' }}
            <span class="text-slate-400 mx-2">·</span>
            <span class="text-slate-500">标签</span> {{ r.tag_name or '-' }}
          </div>
          <div class="text-xs text-slate-500 mt-1">上次更新：{{ r.updated_at.strftime('%Y-%m-%d %H:%M') if r.updated_at else '-' }}</div>
        </div>
        {% if r.is_active %}
          <span class="px-2 py-1 rounded-full bg-green-100 text-green-800 text-xs">启用</span>
        {% else %}
          <span class="px-2 py-1 rounded-full bg-slate-200 text-slate-700 text-xs">停用</span>
        {% endif %}
      </div>

      <form action="/settings/rejected-tags/{{ r.id }}/update" method="post" class="mt-3 grid grid-cols-1 md:grid-cols-2 gap-3">
        <div>
          <label class="block text-xs text-slate-500 mb-1">一级分类</label>
          <input type="text" name="category" value="{{ r.category or '' }}" class="w-full px-3 py-2 rounded-xl border text-sm" />
        </div>
        <div>
          <label class="block text-xs text-slate-500 mb-1">二级标签名</label>
          <input type="text" name="tag_name" value="{{ r.tag_name or '' }}" class="w-full px-3 py-2 rounded-xl border text-sm" />
        </div>
        <div class="md:col-span-2">
          <label class="block text-xs text-slate-500 mb-1">别名/近似词</label>
          <textarea name="aliases" rows="2" class="w-full px-3 py-2 rounded-xl border text-sm">{{ r.aliases or '' }}</textarea>
        </div>
        <div class="md:col-span-2">
          <label class="block text-xs text-slate-500 mb-1">备注</label>
          <input type="text" name="notes" value="{{ r.notes or '' }}" class="w-full px-3 py-2 rounded-xl border text-sm" />
        </div>
        <div class="md:col-span-2 flex items-center gap-3">
          <label class="flex items-center gap-2 text-sm">
            <input type="checkbox" name="is_active" {% if r.is_active %}checked{% endif %} />
            启用
          </label>
          <button type="submit" class="px-4 py-2 rounded-xl bg-slate-900 text-white text-sm">保存</button>
        </div>
      </form>
      <form action="/settings/rejected-tags/{{ r.id }}/remove" method="post" class="mt-2" onsubmit="return confirm('确定删除该驳回规则吗？此操作不可恢复。');">
        <button type="submit" class="px-4 py-2 rounded-xl border text-sm hover:bg-slate-50">删除</button>
      </form>
    </div>
  {% endfor %}
  {% if not rules %}
    <div class="bg-white border rounded-2xl p-8 text-center text-slate-500">暂无驳回规则</div>
  {% endif %}
</div>
{% endblock %}
