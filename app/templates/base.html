<!doctype html>
<html lang="zh">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>{{ title or "客服质检与培训(MVP)" }}</title>
  {# Tailwind must not depend on external CDN (often blocked/unstable in CN). #}
  <link rel="stylesheet" href="{{ request.app.url_path_for('static', path='tailwind.css') }}" />
  <link rel="stylesheet" href="{{ request.app.url_path_for('static', path='app.css') }}" />
</head>
<body class="bg-slate-50 text-slate-900">
  <div class="min-h-screen">
    <div class="bg-white border-b">
      <div class="max-w-6xl mx-auto px-3 sm:px-4 py-3">
        {% if user %}
          {% set _path = request.url.path %}
        {% endif %}

        <div class="flex items-center justify-between gap-3">
          <div class="flex items-center gap-2 min-w-0">
            {% if user %}
              <button
                type="button"
                id="mobileNavOpen"
                class="md:hidden inline-flex items-center justify-center h-9 w-9 rounded-xl border bg-white hover:bg-slate-50"
                aria-label="打开菜单"
              >
                <span class="text-lg leading-none">≡</span>
              </button>
            {% endif %}
            <a href="/conversations" class="font-semibold truncate">客服质检与培训</a>
            {% if user %}
              <span class="text-xs px-2 py-1 rounded-full bg-slate-100 whitespace-nowrap">{{ user.role }}</span>
            {% endif %}
          </div>

          <div class="flex items-center gap-2 text-sm">
            {% if user %}
              {% if user.role in ["admin", "supervisor"] %}
                <details class="relative hidden sm:block">
                  <summary class="list-none cursor-pointer px-3 py-1.5 rounded-lg bg-white border hover:bg-slate-50">系统设置</summary>
                  <div class="absolute right-0 mt-2 w-56 bg-white border rounded-lg shadow-lg p-2 z-50">
                      <a class="block px-3 py-2 rounded hover:bg-slate-50" href="/settings/general">应用设置</a>
                      <a class="block px-3 py-2 rounded hover:bg-slate-50" href="/bindings">客服绑定</a>
                      <a class="block px-3 py-2 rounded hover:bg-slate-50" href="/dashboard">同步概览</a>
                      <a class="block px-3 py-2 rounded hover:bg-slate-50" href="/settings/bucket">桶抓取/导入</a>
                      <a class="block px-3 py-2 rounded hover:bg-slate-50" href="/settings/tags">标签管理</a>
                      <a class="block px-3 py-2 rounded hover:bg-slate-50" href="/settings/ai">AI配置</a>
                      <a class="block px-3 py-2 rounded hover:bg-slate-50" href="/settings/ai/daily">每日AI总结</a>
                    {% if user.role == "admin" %}
                      <a class="block px-3 py-2 rounded hover:bg-slate-50" href="/admin/users">账号管理</a>
                    {% endif %}
                  </div>
                </details>
              {% endif %}
              <span class="hidden sm:inline text-slate-500 max-w-[10rem] truncate">{{ user.name }}</span>
              <a class="hidden sm:inline hover:underline" href="/logout">退出</a>
              <a class="sm:hidden px-3 py-1.5 rounded-lg border bg-white hover:bg-slate-50" href="/logout">退出</a>
            {% else %}
              <a class="hover:underline" href="/login">登录</a>
            {% endif %}
          </div>
        </div>

        {% if user %}
          <nav class="hidden md:flex mt-3 flex-wrap items-center gap-2">
            <a href="/conversations" class="px-3 py-1.5 rounded-lg text-sm hover:bg-slate-50 {{ 'bg-slate-900 text-white' if _path.startswith('/conversations') else 'bg-white border' }}">聊天记录</a>
            {% if user.role in ['admin','supervisor'] %}
              <a href="/qc/daily" class="px-3 py-1.5 rounded-lg text-sm hover:bg-slate-50 {{ 'bg-slate-900 text-white' if _path == '/qc/daily' else 'bg-white border' }}">AI质检</a>
              <a href="/settings/tag-suggestions" class="px-3 py-1.5 rounded-lg text-sm hover:bg-slate-50 {{ 'bg-slate-900 text-white' if _path.startswith('/settings/tag-suggestions') else 'bg-white border' }}">标签建议</a>
            {% endif %}
            <a href="/tasks" class="px-3 py-1.5 rounded-lg text-sm hover:bg-slate-50 {{ 'bg-slate-900 text-white' if _path.startswith('/tasks') else 'bg-white border' }}">培训</a>
            <a href="/reports" class="px-3 py-1.5 rounded-lg text-sm hover:bg-slate-50 {{ 'bg-slate-900 text-white' if (_path == '/reports' or _path.startswith('/reports/daily') or _path.startswith('/reports/ai') or _path.startswith('/reports/voc')) else 'bg-white border' }}">报表</a>
            <a href="/reports/tags" class="px-3 py-1.5 rounded-lg text-sm hover:bg-slate-50 {{ 'bg-slate-900 text-white' if _path.startswith('/reports/tags') else 'bg-white border' }}">标签报表</a>
            <a href="/reports/agent-analysis" class="px-3 py-1.5 rounded-lg text-sm hover:bg-slate-50 {{ 'bg-slate-900 text-white' if _path.startswith('/reports/agent-analysis') else 'bg-white border' }}">客服分析</a>
          </nav>
        {% endif %}
      </div>
    </div>

    {% set _wide_layout = (wide_layout if wide_layout is defined else False) %}
    <main class="{{ 'max-w-[1400px]' if _wide_layout else 'max-w-6xl' }} mx-auto px-3 sm:px-4 py-4 sm:py-6">
      {% block content %}{% endblock %}
    </main>
  </div>

  {% if user %}
    <!-- Mobile nav -->
    <div id="mobileNav" class="fixed inset-0 z-[65] hidden" aria-hidden="true">
      <div id="mobileNavBackdrop" class="absolute inset-0 bg-slate-900/40"></div>
      <div class="absolute inset-y-0 left-0 w-[86%] max-w-sm bg-white border-r shadow-xl overflow-y-auto">
        <div class="p-4 border-b">
          <div class="flex items-start justify-between gap-3">
            <div class="min-w-0">
              <div class="text-xs text-slate-500">{{ user.role }} · {{ user.name }}</div>
              <div class="font-semibold mt-1 truncate">菜单</div>
            </div>
            <button id="mobileNavClose" type="button" class="px-3 py-1.5 rounded-lg bg-white border text-sm hover:bg-slate-50">关闭</button>
          </div>
        </div>

        <div class="p-4 space-y-1">
          <a href="/conversations" class="block px-3 py-2 rounded-xl {{ 'bg-slate-900 text-white' if _path.startswith('/conversations') else 'bg-white border border-slate-200 hover:bg-slate-50' }}">聊天记录</a>
          {% if user.role in ['admin','supervisor'] %}
            <a href="/qc/daily" class="block px-3 py-2 rounded-xl {{ 'bg-slate-900 text-white' if _path == '/qc/daily' else 'bg-white border border-slate-200 hover:bg-slate-50' }}">AI质检</a>
            <a href="/settings/tag-suggestions" class="block px-3 py-2 rounded-xl {{ 'bg-slate-900 text-white' if _path.startswith('/settings/tag-suggestions') else 'bg-white border border-slate-200 hover:bg-slate-50' }}">标签建议</a>
          {% endif %}
          <a href="/tasks" class="block px-3 py-2 rounded-xl {{ 'bg-slate-900 text-white' if _path.startswith('/tasks') else 'bg-white border border-slate-200 hover:bg-slate-50' }}">培训</a>
          <a href="/reports" class="block px-3 py-2 rounded-xl {{ 'bg-slate-900 text-white' if (_path == '/reports' or _path.startswith('/reports/daily') or _path.startswith('/reports/ai') or _path.startswith('/reports/voc')) else 'bg-white border border-slate-200 hover:bg-slate-50' }}">报表</a>
          <a href="/reports/tags" class="block px-3 py-2 rounded-xl {{ 'bg-slate-900 text-white' if _path.startswith('/reports/tags') else 'bg-white border border-slate-200 hover:bg-slate-50' }}">标签报表</a>
          <a href="/reports/agent-analysis" class="block px-3 py-2 rounded-xl {{ 'bg-slate-900 text-white' if _path.startswith('/reports/agent-analysis') else 'bg-white border border-slate-200 hover:bg-slate-50' }}">客服分析</a>
        </div>

        {% if user.role in ["admin", "supervisor"] %}
          <div class="px-4 pb-4">
            <div class="pt-4 border-t">
              <div class="text-xs text-slate-500 mb-2">系统设置</div>
              <div class="space-y-1">
                <a class="block px-3 py-2 rounded-xl hover:bg-slate-50 border" href="/settings/general">应用设置</a>
                <a class="block px-3 py-2 rounded-xl hover:bg-slate-50 border" href="/bindings">客服绑定</a>
                <a class="block px-3 py-2 rounded-xl hover:bg-slate-50 border" href="/dashboard">同步概览</a>
                <a class="block px-3 py-2 rounded-xl hover:bg-slate-50 border" href="/settings/bucket">桶抓取/导入</a>
                <a class="block px-3 py-2 rounded-xl hover:bg-slate-50 border" href="/settings/tags">标签管理</a>
                <a class="block px-3 py-2 rounded-xl hover:bg-slate-50 border" href="/settings/ai">AI配置</a>
                <a class="block px-3 py-2 rounded-xl hover:bg-slate-50 border" href="/settings/ai/daily">每日AI总结</a>
                {% if user.role == "admin" %}
                  <a class="block px-3 py-2 rounded-xl hover:bg-slate-50 border" href="/admin/users">账号管理</a>
                {% endif %}
              </div>
            </div>
          </div>
        {% endif %}

        <div class="px-4 pb-6">
          <div class="pt-4 border-t">
            <a href="/logout" class="block px-3 py-2 rounded-xl border text-red-700 hover:bg-red-50">退出登录</a>
          </div>
        </div>
      </div>
    </div>
  {% endif %}

  <!-- CID quick preview modal (auto-activated when users click "CID=xxxx" anywhere) -->
  <div id="cidModal" class="fixed inset-0 z-[60] hidden" aria-hidden="true">
    <div id="cidModalBackdrop" class="absolute inset-0 bg-slate-900/40"></div>
    <div class="absolute inset-0 flex items-center justify-center p-4">
      <div class="w-full max-w-3xl bg-white rounded-2xl shadow-xl border overflow-hidden">
        <div class="px-4 py-3 border-b flex items-center justify-between gap-3">
          <div class="min-w-0">
            <div class="text-sm text-slate-500" id="cidModalMeta">对话预览</div>
            <div class="font-semibold truncate" id="cidModalTitle">CID</div>
          </div>
          <div class="flex items-center gap-2">
            <a id="cidModalOpenFull" class="px-3 py-1.5 rounded-lg bg-slate-900 text-white text-sm" href="#">打开完整聊天</a>
            <button id="cidModalClose" class="px-3 py-1.5 rounded-lg bg-white border text-sm hover:bg-slate-50">关闭</button>
          </div>
        </div>
        <div class="p-4">
          <div id="cidModalStatus" class="text-sm text-slate-500">加载中…</div>
          <div id="cidModalBody" class="mt-3 max-h-[70vh] overflow-auto space-y-2 hidden"></div>
        </div>
        <div id="cidModalFooter" class="px-4 py-3 border-t bg-slate-50 text-xs text-slate-500 hidden"></div>
      </div>
    </div>
  </div>

  <script>
    // Body scroll lock manager (mobile-friendly, supports nested locks)
    (function () {
      if (window.__marllenScrollLock) return;

      const state = {
        count: 0,
        scrollY: 0,
        prevBody: null,
        prevHtml: null,
      };

      function lock() {
        state.count += 1;
        if (state.count !== 1) return;

        const body = document.body;
        const html = document.documentElement;
        if (!body || !html) return;

        state.scrollY = window.scrollY || window.pageYOffset || 0;
        state.prevBody = {
          position: body.style.position || "",
          top: body.style.top || "",
          left: body.style.left || "",
          right: body.style.right || "",
          width: body.style.width || "",
          overflow: body.style.overflow || "",
        };
        state.prevHtml = {
          overflow: html.style.overflow || "",
          overscrollBehavior: html.style.overscrollBehavior || "",
        };

        // iOS/Safari: overflow hidden alone is not enough; use position: fixed.
        body.style.position = "fixed";
        body.style.top = "-" + String(state.scrollY) + "px";
        body.style.left = "0";
        body.style.right = "0";
        body.style.width = "100%";
        body.style.overflow = "hidden";

        // Avoid scroll chaining on supporting browsers.
        html.style.overflow = "hidden";
        html.style.overscrollBehavior = "none";
      }

      function unlock() {
        if (state.count <= 0) return;
        state.count -= 1;
        if (state.count !== 0) return;

        const body = document.body;
        const html = document.documentElement;
        if (!body || !html) return;

        const y = state.scrollY || 0;
        const prevBody = state.prevBody || {};
        const prevHtml = state.prevHtml || {};

        body.style.position = prevBody.position || "";
        body.style.top = prevBody.top || "";
        body.style.left = prevBody.left || "";
        body.style.right = prevBody.right || "";
        body.style.width = prevBody.width || "";
        body.style.overflow = prevBody.overflow || "";

        html.style.overflow = prevHtml.overflow || "";
        html.style.overscrollBehavior = prevHtml.overscrollBehavior || "";

        state.prevBody = null;
        state.prevHtml = null;
        state.scrollY = 0;

        try { window.scrollTo(0, y); } catch (e) {}
      }

      window.__marllenScrollLock = { lock, unlock };
    })();
  </script>

  <script>
    (function () {
      const CID_RE = /\bCID=(\d+)\b/g;
      const SKIP_TAGS = new Set(["SCRIPT","STYLE","TEXTAREA","INPUT","CODE","PRE"]);

      function linkifyCID(root) {
        if (!root) return;

        const walker = document.createTreeWalker(
          root,
          NodeFilter.SHOW_TEXT,
          {
            acceptNode: (node) => {
              const p = node.parentElement;
              if (!p) return NodeFilter.FILTER_REJECT;
              if (SKIP_TAGS.has(p.tagName)) return NodeFilter.FILTER_REJECT;
              if (p.closest("a")) return NodeFilter.FILTER_REJECT;
              if (!node.nodeValue || node.nodeValue.indexOf("CID=") === -1) return NodeFilter.FILTER_REJECT;
              return NodeFilter.FILTER_ACCEPT;
            }
          }
        );

        const nodes = [];
        while (walker.nextNode()) nodes.push(walker.currentNode);

        for (const node of nodes) {
          const text = node.nodeValue || "";
          let m;
          CID_RE.lastIndex = 0;
          if (!CID_RE.test(text)) continue;
          CID_RE.lastIndex = 0;

          const frag = document.createDocumentFragment();
          let last = 0;
          while ((m = CID_RE.exec(text)) !== null) {
            const before = text.slice(last, m.index);
            if (before) frag.appendChild(document.createTextNode(before));

            const cid = m[1];
            const a = document.createElement("a");
            a.href = "#";
            a.className = "cid-link underline decoration-dotted text-indigo-600 hover:text-indigo-700";
            a.dataset.cid = cid;
            a.textContent = "CID=" + cid;
            frag.appendChild(a);

            last = m.index + m[0].length;
          }
          const after = text.slice(last);
          if (after) frag.appendChild(document.createTextNode(after));

          node.parentNode && node.parentNode.replaceChild(frag, node);
        }
      }

      // Modal
      const modal = document.getElementById("cidModal");
      const backdrop = document.getElementById("cidModalBackdrop");
      const btnClose = document.getElementById("cidModalClose");
      const elTitle = document.getElementById("cidModalTitle");
      const elMeta = document.getElementById("cidModalMeta");
      const elStatus = document.getElementById("cidModalStatus");
      const elBody = document.getElementById("cidModalBody");
      const elFooter = document.getElementById("cidModalFooter");
      const elOpenFull = document.getElementById("cidModalOpenFull");

      function showModal() {
        if (!modal) return;
        modal.classList.remove("hidden");
        modal.setAttribute("aria-hidden", "false");
        try { window.__marllenScrollLock && window.__marllenScrollLock.lock(); } catch (e) {}
      }

      function hideModal() {
        if (!modal) return;
        modal.classList.add("hidden");
        modal.setAttribute("aria-hidden", "true");
        try { window.__marllenScrollLock && window.__marllenScrollLock.unlock(); } catch (e) {}
      }

      function senderLabel(sender) {
        if (sender === "buyer") return "买家";
        if (sender === "agent") return "客服";
        if (sender === "system") return "系统";
        return sender || "-";
      }

      function renderMessages(messages) {
        elBody.innerHTML = "";
        for (const msg of messages || []) {
          const row = document.createElement("div");
          row.className = "flex";

          const sender = msg.sender || "";
          const isBuyer = sender === "buyer";
          const isAgent = sender === "agent";

          row.classList.add(isBuyer ? "justify-start" : (isAgent ? "justify-end" : "justify-center"));

          const bubble = document.createElement("div");
          bubble.className = "max-w-[90%] rounded-2xl px-3 py-2 border bg-white";

          const head = document.createElement("div");
          head.className = "text-xs text-slate-500 flex items-center justify-between gap-2";
          const s = document.createElement("span");
          s.textContent = (msg.sender_display || senderLabel(sender));
          const t = document.createElement("span");
          t.textContent = msg.ts ? (new Date(msg.ts)).toLocaleString() : "";
          head.appendChild(s);
          head.appendChild(t);

          const body = document.createElement("div");
          body.className = "mt-1 whitespace-pre-wrap text-sm leading-relaxed";
          body.textContent = (msg.text || "").trim() || "（空）";

          bubble.appendChild(head);
          bubble.appendChild(body);

          // attachments
          // - render images inline
          // - ignore internal meta/refs
          // - only show file links when url exists
          const attsRaw = Array.isArray(msg.attachments) ? msg.attachments : [];
          const atts = attsRaw.filter(a => a && typeof a === "object");

          const images = atts.filter(a => a.type === "image" && a.url);
          const files = atts.filter(a => a.url && a.type && a.type !== "image" && a.type !== "meta" && a.type !== "refs");

          if (images.length) {
            const imgWrap = document.createElement("div");
            imgWrap.className = "mt-2 flex flex-wrap gap-2";
            for (const a of images) {
              const url = String(a.url);
              const link = document.createElement("a");
              link.href = url;
              link.target = "_blank";
              link.rel = "noopener noreferrer";
              link.className = "block";

              const img = document.createElement("img");
              img.src = url;
              img.alt = "image";
              img.loading = "lazy";
              img.className = "max-h-48 rounded-xl border";

              link.appendChild(img);
              imgWrap.appendChild(link);
            }
            bubble.appendChild(imgWrap);
          }

          if (files.length) {
            const list = document.createElement("div");
            list.className = "mt-2 space-y-1";
            for (const a of files) {
              const url = String(a.url);
              const item = document.createElement("a");
              item.className = "text-xs underline text-slate-600 hover:text-slate-800 block";
              item.href = url;
              item.target = "_blank";
              item.rel = "noopener noreferrer";
              const name = (a && (a.name || a.filename || a.type)) ? String(a.name || a.filename || a.type) : "附件";
              item.textContent = "附件：" + name;
              list.appendChild(item);
            }
            bubble.appendChild(list);
          }

          row.appendChild(bubble);
          elBody.appendChild(row);
        }

        // Make CID=xxxx inside the modal clickable too
        linkifyCID(elBody);
      }

      async function openCidModal(cid) {
        if (!cid) return;
        showModal();

        elTitle.textContent = "CID=" + cid;
        elMeta.textContent = "对话预览";
        elOpenFull.href = "/conversations/" + cid;

        elStatus.textContent = "加载中…";
        elStatus.classList.remove("hidden");
        elBody.classList.add("hidden");
        elFooter.classList.add("hidden");

        try {
          const resp = await fetch("/api/conversations/" + cid + "/preview?limit=200", { credentials: "same-origin" });
          const data = await resp.json().catch(() => ({}));

          if (!resp.ok) {
            const msg = (data && data.detail) ? String(data.detail) : ("加载失败（" + resp.status + "）");
            elStatus.textContent = msg;
            return;
          }

          const conv = data.conversation || {};
          const total = Number(data.total_messages || 0);
          const truncated = !!data.is_truncated;

          elMeta.textContent = [
            conv.platform ? ("平台：" + conv.platform) : null,
            conv.buyer_id ? ("买家：" + conv.buyer_id) : null,
            conv.agent_account ? ("客服账号：" + conv.agent_account) : null
          ].filter(Boolean).join(" · ") || "对话预览";

          renderMessages(data.messages || []);

          elStatus.classList.add("hidden");
          elBody.classList.remove("hidden");

          elFooter.textContent = truncated
            ? ("为保证速度，这里只展示最新 " + (data.messages || []).length + " 条 / 共 " + total + " 条。")
            : ("共 " + total + " 条消息。");
          elFooter.classList.remove("hidden");
        } catch (e) {
          elStatus.textContent = "网络错误，稍后再试。";
        }
      }

      // Global click handler for CID links
      document.addEventListener("click", function (e) {
        const a = e.target && e.target.closest ? e.target.closest(".cid-link") : null;
        if (!a) return;
        e.preventDefault();
        const cid = a.dataset && a.dataset.cid ? a.dataset.cid : "";
        openCidModal(cid);
      });

      // Close interactions
      if (btnClose) btnClose.addEventListener("click", hideModal);
      if (backdrop) backdrop.addEventListener("click", hideModal);
      document.addEventListener("keydown", function (e) {
        if (e.key === "Escape") hideModal();
      });

      // Initial pass + future dynamic content
      if (document.readyState === "loading") {
        document.addEventListener("DOMContentLoaded", function () {
          linkifyCID(document.body);
        });
      } else {
        linkifyCID(document.body);
      }

      // Observe new nodes (future pages / async inserts)
      const mo = new MutationObserver(function (mutations) {
        for (const m of mutations) {
          for (const n of m.addedNodes || []) {
            if (n && n.nodeType === 1) linkifyCID(n);
          }
        }
      });
      mo.observe(document.body, { childList: true, subtree: true });
    })();
  </script>

  <script>
    (function () {
      const nav = document.getElementById("mobileNav");
      if (!nav) return;

      const btnOpen = document.getElementById("mobileNavOpen");
      const btnClose = document.getElementById("mobileNavClose");
      const backdrop = document.getElementById("mobileNavBackdrop");

      function open() {
        nav.classList.remove("hidden");
        nav.setAttribute("aria-hidden", "false");
        try { window.__marllenScrollLock && window.__marllenScrollLock.lock(); } catch (e) {}
      }

      function close() {
        nav.classList.add("hidden");
        nav.setAttribute("aria-hidden", "true");
        try { window.__marllenScrollLock && window.__marllenScrollLock.unlock(); } catch (e) {}
      }

      btnOpen && btnOpen.addEventListener("click", open);
      btnClose && btnClose.addEventListener("click", close);
      backdrop && backdrop.addEventListener("click", close);
      nav.querySelectorAll("a").forEach((a) => a.addEventListener("click", close));
      document.addEventListener("keydown", function (e) {
        if (e.key === "Escape") close();
      });
    })();
  </script>

  {% if user and user.role in ["admin", "supervisor", "agent"] %}
    <!-- Marllen Assistant: draggable floating AI butler -->
    <div
      id="marllenAssistant"
      class="fixed z-[55]"
      style="right: 16px; bottom: 16px;"
      data-can-write="1"
      data-read-only="{{ '1' if user.role == 'agent' else '0' }}"
      data-user-role="{{ user.role }}"
    >
      <!-- Collapsed FAB -->
      <button
        id="marllenAssistantFab"
        type="button"
        class="group inline-flex items-center gap-2 pl-2 pr-3 py-2 rounded-2xl bg-gradient-to-br from-slate-900 to-slate-700 text-white shadow-xl hover:from-slate-800 hover:to-slate-700 ring-1 ring-white/10"
        aria-label="打开 Marllen 小助手"
      >
        <span class="inline-flex h-9 w-9 items-center justify-center rounded-xl bg-white shadow-sm ring-1 ring-black/5 group-hover:bg-white">
          <span class="marllen-logo h-5 w-5" aria-hidden="true"></span>
        </span>
        <span class="leading-tight text-left">
          <span class="block text-sm font-semibold">Marllen小助手</span>
          <span class="block text-[11px] text-white/80">欢迎咨询任何关于客服的问题!</span>
        </span>
      </button>

      <!-- Expanded panel -->
      <div id="marllenAssistantPanel" class="relative hidden w-[340px] sm:w-[420px] h-[560px] max-h-[calc(100vh-32px)] bg-white/90 backdrop-blur border border-slate-200 rounded-2xl shadow-[0_24px_80px_rgba(0,0,0,0.18)] overflow-hidden flex flex-col">
        <div id="marllenAssistantHeader" class="px-3 py-2 bg-white/70 backdrop-blur border-b flex items-center justify-between cursor-move select-none">
          <div class="flex items-center gap-2 min-w-0">
            <div class="h-9 w-9 rounded-xl bg-white ring-1 ring-slate-200 flex items-center justify-center shadow-sm">
              <span class="marllen-logo h-5 w-5" aria-hidden="true"></span>
            </div>
            <div class="min-w-0">
              <div class="flex items-center gap-2 min-w-0">
                <div class="text-sm font-semibold truncate">Marllen小助手</div>
                <span id="marllenAssistantMode" class="hidden text-[10px] px-2 py-0.5 rounded-full bg-slate-100 text-slate-600 whitespace-nowrap">只读</span>
              </div>
              <div id="marllenAssistantStatus" class="text-[11px] text-slate-500 hidden"></div>
            </div>
          </div>
          <div class="flex items-center gap-2">
            <button id="marllenAssistantThreads" type="button" class="px-3 py-1.5 rounded-xl border bg-white text-xs hover:bg-slate-50">对话</button>
            <button id="marllenAssistantNew" type="button" class="px-3 py-1.5 rounded-xl border bg-white text-xs hover:bg-slate-50">新对话</button>
            <button id="marllenAssistantMin" type="button" class="px-3 py-1.5 rounded-xl border bg-white text-xs hover:bg-slate-50">收起</button>
          </div>
        </div>

        <div id="marllenAssistantError" class="hidden px-3 py-2 text-xs text-red-700 bg-red-50 border-b whitespace-pre-wrap"></div>

        <div id="marllenAssistantMessages" class="flex-1 overflow-auto p-3 space-y-2 bg-slate-50"></div>

        <div class="p-3 border-t bg-white">
          <div id="marllenAssistantTip" class="mb-2 flex items-start gap-2 rounded-xl bg-amber-50 border border-amber-100 px-3 py-2 text-[11px] text-amber-900">
            <div class="mt-[1px] inline-flex h-5 w-5 items-center justify-center rounded-lg bg-amber-100 text-amber-700 font-bold">!</div>
            <div class="leading-relaxed flex-1">
              复杂问题会去数据库检索与分析，可能需要几十秒～30分钟才回复（不是秒回）。期间系统一次只处理一个问题；如果等得太久，可以点“终止”结束本次生成。
            </div>
            <button
              id="marllenAssistantTipClose"
              type="button"
              class="shrink-0 -mr-1 mt-[1px] rounded-lg p-1 text-amber-700/80 hover:bg-amber-100 hover:text-amber-800"
              aria-label="关闭提示"
              title="关闭提示"
            >
              <svg viewBox="0 0 20 20" fill="currentColor" class="h-4 w-4" aria-hidden="true">
                <path d="M6.28 5.22a.75.75 0 0 0-1.06 1.06L8.94 10l-3.72 3.72a.75.75 0 1 0 1.06 1.06L10 11.06l3.72 3.72a.75.75 0 1 0 1.06-1.06L11.06 10l3.72-3.72a.75.75 0 0 0-1.06-1.06L10 8.94 6.28 5.22Z"/>
              </svg>
            </button>
          </div>
          <!-- Live execution output (Codex) -->
          <div id="marllenAssistantExec" class="hidden mb-2 rounded-xl border border-slate-200 bg-slate-50 overflow-hidden">
            <div class="px-3 py-2 bg-white/70 backdrop-blur border-b flex items-center justify-between">
              <div class="text-[11px] font-semibold text-slate-700">实时执行</div>
              <div class="flex items-center gap-2">
                <button id="marllenAssistantExecToggle" type="button" class="px-2 py-1 rounded-lg border border-slate-200 bg-white text-[11px] hover:bg-slate-50">收起</button>
                <button id="marllenAssistantCancel" type="button" class="px-2 py-1 rounded-lg border border-red-200 bg-red-50 text-[11px] text-red-700 hover:bg-red-100 disabled:opacity-60">终止</button>
              </div>
            </div>
            <div id="marllenAssistantExecMeta" class="hidden px-3 py-1.5 text-[11px] text-slate-500 border-b bg-white/60"></div>
            <pre id="marllenAssistantExecLog" class="px-3 py-2 text-[11px] leading-relaxed text-slate-700 whitespace-pre-wrap font-mono max-h-44 overflow-auto"></pre>
          </div>
          <div class="flex items-end gap-2">
            <textarea
              id="marllenAssistantInput"
              rows="2"
              class="flex-1 border border-slate-200 rounded-xl px-3 py-2 text-sm bg-white focus:outline-none focus:ring-2 focus:ring-slate-200 focus:border-slate-300 placeholder:text-slate-400"
            ></textarea>
            <button id="marllenAssistantSend" type="button" class="px-4 py-2 rounded-xl bg-slate-900 text-white text-sm hover:bg-slate-800 active:scale-[0.99] disabled:opacity-60">发送</button>
          </div>
          <div class="mt-2 text-[11px] text-slate-500">Enter 发送，Shift+Enter 换行。回答会写入后台，刷新/换页不丢。</div>
        </div>

        <!-- Threads overlay (conversation switcher) -->
        <div id="marllenAssistantThreadsOverlay" class="hidden absolute inset-0 bg-white/95 backdrop-blur flex flex-col">
          <div class="px-3 py-2 border-b bg-white/80 backdrop-blur flex items-center justify-between">
            <div class="min-w-0">
              <div class="text-sm font-semibold truncate">对话列表</div>
              <div class="text-[11px] text-slate-500">切换之前的提问</div>
            </div>
            <button id="marllenAssistantThreadsClose" type="button" class="px-3 py-1.5 rounded-xl border bg-white text-xs hover:bg-slate-50">关闭</button>
          </div>
          <div class="p-2 border-b bg-white/70">
            <input id="marllenAssistantThreadsSearch" type="text" class="w-full border border-slate-200 rounded-xl px-3 py-2 text-sm bg-white focus:outline-none focus:ring-2 focus:ring-slate-200 focus:border-slate-300 placeholder:text-slate-400" placeholder="搜索标题…" />
          </div>
          <div id="marllenAssistantThreadsList" class="flex-1 overflow-auto p-2 space-y-2"></div>
          <div id="marllenAssistantThreadsHint" class="px-3 py-2 text-[11px] text-slate-500 border-t bg-white/70 hidden"></div>
        </div>
      </div>
    </div>
    <script src="{{ request.app.url_path_for('static', path='marllen_assistant.js') }}"></script>
  {% endif %}

</body>
</html>
