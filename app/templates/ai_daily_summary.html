{% extends "base.html" %}
{% block content %}
<div class="max-w-4xl mx-auto space-y-4">
  <div class="bg-white border rounded-2xl p-4">
    <div class="flex items-center gap-2 mb-4">
      <a href="/settings/ai" class="px-3 py-1.5 rounded-xl text-sm {% if active_tab == 'ai' %}bg-slate-900 text-white{% else %}bg-white border hover:bg-slate-50{% endif %}">AI配置</a>
      <a href="/settings/ai/daily" class="px-3 py-1.5 rounded-xl text-sm {% if active_tab == 'daily' %}bg-slate-900 text-white{% else %}bg-white border hover:bg-slate-50{% endif %}">每日AI总结</a>
    </div>

    <div class="flex items-start justify-between gap-3">
      <div>
        <h1 class="text-xl font-semibold">每日全部对话AI总结</h1>
        <div class="mt-2 text-sm text-slate-600">
          用于管理者快速掌握当天对话的重点：客户问题、客服改进点、VOC、以及需要跟进的对话清单。
        </div>
      </div>
      <div class="text-right text-xs text-slate-500">
        默认模型：<span class="font-mono">{{ cfg.daily_summary_model or env_default_model }}</span>
        <div class="mt-2"><a href="/reports/daily-ai" class="text-slate-900 underline">查看历史报告</a></div>
      </div>
    </div>


    <div class="mt-4 border rounded-2xl p-4 bg-white">
      <div class="flex items-center justify-between">
        <div class="text-sm font-semibold">已有日报（点日期直接查看）</div>
        <a href="/reports/daily-ai" class="text-sm text-slate-900 underline">全部历史</a>
      </div>

      {% if recent_reports %}
        <div class="mt-3 flex flex-wrap gap-2">
          {% for r in recent_reports %}
            <a href="/reports/daily-ai/{{ r.run_date }}" class="px-3 py-1.5 rounded-xl border text-sm hover:bg-slate-50 {% if r.run_date == run_date %}bg-slate-900 text-white border-slate-900 hover:bg-slate-900{% endif %}">
              {{ r.run_date }}
            </a>
          {% endfor %}
        </div>
      {% else %}
        <div class="mt-2 text-sm text-slate-500">暂时还没有保存的日报。</div>
      {% endif %}
    </div>

    {% if saved %}
      <div class="mt-4 p-3 rounded-xl bg-green-50 border text-sm">已生成并保存（如同一天重新生成，会覆盖旧报告）。</div>
    {% endif %}
    {% if queued %}
      <div class="mt-4 p-3 rounded-xl bg-blue-50 border text-sm">已提交后台生成：通常需要几分钟。你可以先离开这个页面，稍后回来刷新即可看到结果。</div>
    {% endif %}
    {% if error %}
      <div class="mt-4 p-3 rounded-xl bg-red-50 border text-sm">{{ error }}</div>
    {% endif %}

    {% if job and (job.status != 'done') %}
      <div class="mt-4 border rounded-2xl p-4 bg-white">
        <div class="flex items-start justify-between gap-3">
          <div>
            <div class="text-sm font-semibold">后台任务状态：{{ job.status }}</div>
            <div class="text-xs text-slate-500 mt-1">
              创建于 {{ job.created_at }}{% if job.started_at %} · 开始于 {{ job.started_at }}{% endif %}
            </div>
            {% if job.last_error %}
              <div class="mt-2 text-sm text-red-700 whitespace-pre-wrap">{{ job.last_error }}</div>
            {% else %}
              <div class="mt-2 text-sm text-slate-600">任务在后台运行中；页面刷新不会影响生成。</div>
            {% endif %}
          </div>
          <div class="text-right text-sm">
            <a href="/settings/ai/daily?date={{ run_date }}" class="px-3 py-2 rounded-xl border bg-white hover:bg-slate-50">刷新状态</a>
          </div>
        </div>
      </div>
      <script>
        // Auto refresh every 10s while pending/running
        setTimeout(function() {
          try { window.location.href = "/settings/ai/daily?date={{ run_date }}"; } catch(e) {}
        }, 10000);
      </script>
    {% endif %}


    {% if report %}
      <div class="mt-6 border rounded-2xl p-4 bg-white">
        <div class="flex items-center justify-between">
          <div>
            <div class="text-sm font-semibold">已生成报告：{{ report.run_date }}</div>
            <div class="text-xs text-slate-500 mt-1">纳入：{{ report.included_conversations }} 个对话 / {{ report.included_messages }} 条消息 · 输入字符约 {{ report.input_chars }}</div>
          </div>
          <a href="/reports/daily-ai/{{ report.run_date }}" class="px-3 py-2 rounded-xl border bg-white text-sm hover:bg-slate-50 mr-2">独立查看</a>
          <a href="/settings/ai/daily/export?date={{ report.run_date }}" class="px-3 py-2 rounded-xl border bg-white text-sm hover:bg-slate-50">导出 TXT</a>
        </div>

        <pre class="mt-4 whitespace-pre-wrap text-sm bg-slate-900 text-slate-50 rounded-2xl p-4 overflow-auto">{{ report.report_text }}</pre>
      </div>
    {% endif %}

<form method="post" action="/settings/ai/daily" class="mt-4 border rounded-2xl p-4 bg-slate-50 space-y-3">

      <div class="grid grid-cols-1 md:grid-cols-4 gap-3">
        <div>
          <label class="block text-xs text-slate-500 mb-1">日期</label>
          <input type="date" name="run_date" value="{{ run_date }}" class="w-full border rounded-xl px-3 py-2 text-sm" />
        </div>
        <div>
          <label class="block text-xs text-slate-500 mb-1">纳入阈值（消息数≥）</label>
          <input type="number" min="1" max="500" name="threshold_messages" value="{{ threshold_messages }}" class="w-full border rounded-xl px-3 py-2 text-sm" />
        </div>
        <div>
          <label class="block text-xs text-slate-500 mb-1">模型</label>
          <input list="model_ids" name="model" value="{{ cfg.daily_summary_model or env_default_model }}" class="w-full border rounded-xl px-3 py-2 text-sm font-mono" />
          <datalist id="model_ids">
            {% for mid in (model_ids or []) %}
              <option value="{{ mid }}"></option>
            {% endfor %}
          </datalist>
          {% if not model_ids %}
            <div class="text-xs text-slate-500 mt-1">提示：当前 relay 可能不支持 /v1/models，因此这里不给列表；你仍可手填模型 ID。</div>
          {% endif %}
        </div>
        <div class="flex items-end gap-2">
          <button name="action" value="estimate" class="px-4 py-2 rounded-xl bg-slate-900 text-white text-sm">先预估字符</button>
          <button name="action" value="generate" {% if not estimate %}disabled{% endif %} class="px-4 py-2 rounded-xl {% if estimate %}bg-slate-900 text-white{% else %}bg-slate-200 text-slate-500{% endif %} text-sm">确认生成</button>
          <button name="action" value="save_defaults" class="px-4 py-2 rounded-xl border bg-white text-sm hover:bg-slate-50">保存为默认</button>
        </div>
      </div>

      <div>
        <label class="block text-xs text-slate-500 mb-1">自定义 Prompt（会保存到默认，可在生成前临时修改）</label>
        <textarea name="prompt" rows="10" class="w-full border rounded-xl px-3 py-2 text-sm font-mono">{{ prompt }}</textarea>
      </div>
    </form>

    {% if estimate %}
      <div class="mt-4 border rounded-2xl p-4 bg-white">
        <div class="text-sm font-medium">预估喂入模型字符</div>
        <div class="mt-2 grid grid-cols-1 md:grid-cols-3 gap-3 text-sm">
          <div class="p-3 rounded-xl border">
            <div class="text-xs text-slate-500">输入字符数（约）</div>
            <div class="text-2xl font-semibold mt-1">{{ estimate.input_chars }}</div>
          </div>
          <div class="p-3 rounded-xl border">
            <div class="text-xs text-slate-500">纳入对话数</div>
            <div class="text-2xl font-semibold mt-1">{{ estimate.included_conversations }}</div>
          </div>
          <div class="p-3 rounded-xl border">
            <div class="text-xs text-slate-500">纳入消息数</div>
            <div class="text-2xl font-semibold mt-1">{{ estimate.included_messages }}</div>
          </div>
        </div>
        <div class="mt-3 text-xs text-slate-500">
          说明：这里只是大概字符数（不等同 token）。如果字符数很大，系统会自动分段汇总后再合并。
        </div>

        <div class="mt-4 flex items-center gap-2">
          <div class="text-sm text-slate-600">如果没问题，直接点上面的「确认生成」。</div>
          <a href="/settings/ai/daily" class="px-4 py-2 rounded-xl border bg-white text-sm hover:bg-slate-50">取消</a>
        </div>
      </div>
    {% endif %}

    
  </div>
</div>
{% endblock %}
